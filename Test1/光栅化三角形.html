<!DOCTYPE html>
<!-- saved from url=(0052)https://www.kancloud.cn/digest/soft-3d-engine/130056 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
<title>四，填充光栅化的三角形并使用深度缓冲 · 3D软件渲染器入门  · 看云</title>
    <meta name="description" content="本系列中我们将使用C#、JavaScript、TypeScript三种语言进行编写，并配合Html5做在线演示。为了更好的了解现代3D图形学基础，我们使用CPU来完成3D渲染，让你对图形的认识更加深刻。
        ">
    <meta name="keywords" content="文档托管,在线创作,文档在线管理,在线知识管理,文档托管平台,在线写书,文档在线转换,在线编辑,在线阅读,开发手册,api手册,文档在线学习,技术文档在线阅读,在线文档编辑">
            <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" data-react-helmet="true">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
                    
<script src="./光栅化三角形_files/index.js.下载" async="" data-plugin-name="highlight"></script><script src="./光栅化三角形_files/index.js(1).下载" async="" data-plugin-name="theme-default"></script><link rel="stylesheet" href="./光栅化三角形_files/style.css"><style type="text/css" data-react-helmet="true">.ಠhighlight-container {
  /**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */
  /* Code blocks */
  /* Inline code */
}
.ಠhighlight-container code[class*="language-"],
.ಠhighlight-container pre[class*="language-"] {
  color: black;
  background: none;
  text-shadow: 0 1px white;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;
  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;
  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}
.ಠhighlight-container pre[class*="language-"]::-moz-selection,
.ಠhighlight-container pre[class*="language-"] ::-moz-selection,
.ಠhighlight-container code[class*="language-"]::-moz-selection,
.ಠhighlight-container code[class*="language-"] ::-moz-selection {
  text-shadow: none;
  background: #b3d4fc;
}
.ಠhighlight-container pre[class*="language-"]::selection,
.ಠhighlight-container pre[class*="language-"] ::selection,
.ಠhighlight-container code[class*="language-"]::selection,
.ಠhighlight-container code[class*="language-"] ::selection {
  text-shadow: none;
  background: #b3d4fc;
}
@media print {
  .ಠhighlight-container code[class*="language-"],
  .ಠhighlight-container pre[class*="language-"] {
    text-shadow: none;
  }
}
.ಠhighlight-container pre[class*="language-"] {
  padding: 1em;
  margin: .5em 0;
  overflow: auto;
}
.ಠhighlight-container :not(pre) > code[class*="language-"],
.ಠhighlight-container pre[class*="language-"] {
  background: #f5f2f0;
}
.ಠhighlight-container :not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
}
.ಠhighlight-container .token.comment,
.ಠhighlight-container .token.prolog,
.ಠhighlight-container .token.doctype,
.ಠhighlight-container .token.cdata {
  color: slategray;
}
.ಠhighlight-container .token.punctuation {
  color: #999;
}
.ಠhighlight-container .namespace {
  opacity: .7;
}
.ಠhighlight-container .token.property,
.ಠhighlight-container .token.tag,
.ಠhighlight-container .token.boolean,
.ಠhighlight-container .token.number,
.ಠhighlight-container .token.constant,
.ಠhighlight-container .token.symbol,
.ಠhighlight-container .token.deleted {
  color: #905;
}
.ಠhighlight-container .token.selector,
.ಠhighlight-container .token.attr-name,
.ಠhighlight-container .token.string,
.ಠhighlight-container .token.char,
.ಠhighlight-container .token.builtin,
.ಠhighlight-container .token.inserted {
  color: #690;
}
.ಠhighlight-container .token.operator,
.ಠhighlight-container .token.entity,
.ಠhighlight-container .token.url,
.ಠhighlight-container .language-css .token.string,
.ಠhighlight-container .style .token.string {
  color: #9a6e3a;
  background: rgba(255, 255, 255, 0.5);
}
.ಠhighlight-container .token.atrule,
.ಠhighlight-container .token.attr-value,
.ಠhighlight-container .token.keyword {
  color: #07a;
}
.ಠhighlight-container .token.function,
.ಠhighlight-container .token.class-name {
  color: #DD4A68;
}
.ಠhighlight-container .token.regex,
.ಠhighlight-container .token.important,
.ಠhighlight-container .token.variable {
  color: #e90;
}
.ಠhighlight-container .token.important,
.ಠhighlight-container .token.bold {
  font-weight: bold;
}
.ಠhighlight-container .token.italic {
  font-style: italic;
}
.ಠhighlight-container .token.entity {
  cursor: help;
}
</style></head>
<body>
<div id="main"><div class="window-container"><img src="./光栅化三角形_files/cover_2016-03-22_56f0f51db025_800x1068.jpg-bookmiddle" style="position: absolute; visibility: hidden;"><div><div class="Loading__loading___1m_fZ"><div class="Loading__bar___21yOt" style="background: rgb(33, 186, 69); width: 0%; display: none;"><div class="Loading__peg___3Y_28"></div></div></div><div class="Loading__spinner___11Pm4"><div class="Loading__icon___3OOyu" style="display: none; border-color: rgb(33, 186, 69);"></div></div></div><div class="window-body with-sidebar"><div class="sidebar"><div class="sidebar-header"><a href="https://www.kancloud.cn/digest/soft-3d-engine" data-no-pjax="true" class="title">3D软件渲染器入门</a><div class="search-form"><div class="ui small fluid icon input"><input type="text" placeholder="请输入搜索关键词..."><i class="icon search"></i></div></div></div><div class="sidebar-body"><div class="catalog-body"><ul><li class=""><div class="wholerow"></div><i class="icon"></i><a href="https://www.kancloud.cn/digest/soft-3d-engine/130052" class="text">前言</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="https://www.kancloud.cn/digest/soft-3d-engine/130053" class="text">一，编写相机、网格和设备对象的核心逻辑</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="https://www.kancloud.cn/digest/soft-3d-engine/130054" class="text">二，绘制线段和三角形来获得线框渲染效果</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="https://www.kancloud.cn/digest/soft-3d-engine/130055" class="text">三，加载通过Blender扩展导出JSON格式的网格</a></li><li class="active"><div class="wholerow"></div><i class="icon"></i><a href="https://www.kancloud.cn/digest/soft-3d-engine/130056" class="text">四，填充光栅化的三角形并使用深度缓冲</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="https://www.kancloud.cn/digest/soft-3d-engine/130057" class="text">五，额外章节，使用技巧和并行处理来提高性能</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="https://www.kancloud.cn/digest/soft-3d-engine/130058" class="text">六，平面着色和高氏着色</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="https://www.kancloud.cn/digest/soft-3d-engine/130059" class="text">七，应用纹理、背面剔除以及一些WebGL相关</a></li></ul></div></div><div class="sidebar-copyright">本文档使用 <a href="https://www.kancloud.cn/" target="_blank">看云</a> 构建</div></div><div class="workspace"><div class="article"><div class="article-head"><div class="left tools"><a class="item icon"><i class="icon align justify"></i></a></div><h1>四，填充光栅化的三角形并使用深度缓冲</h1><div class="right tools"><div role="listbox" aria-expanded="false" class="ui top right pointing dropdown item" tabindex="0"><div class="text" role="alert" aria-live="polite"></div><i aria-hidden="true" class="share alternate icon"></i><div class="menu transition"><div role="option" class="item"><i aria-hidden="true" class="linkify icon"></i><span class="text">复制链接</span></div><div role="option" class="item"><i aria-hidden="true" class="qq icon"></i><span class="text">腾讯QQ</span></div><div role="option" class="item"><i aria-hidden="true" class="weibo icon"></i><span class="text">新浪微博</span></div><div class="header"><p><i class="icon wechat"></i><span class="text">微信扫一扫</span></p><img src="./光栅化三角形_files/barCode"></div></div></div></div></div><div class="article-body kancloud-markdown-body"><p>译者前言：</p>
<p>本文译自<a href="http://blogs.msdn.com/b/davrous/archive/2013/06/13/tutorial-series-learning-how-to-write-a-3d-soft-engine-from-scratch-in-c-typescript-or-javascript.aspx" target="_blank">MSDN</a>，原作者为<a href="https://social.msdn.microsoft.com/profile/david%20rousset/" target="_blank">David Rousset</a>，文章中如果有我的额外说明，我会加上【译者注：】。</p>
<p>正文开始：</p>
<p>在前面的教程中，我们学习了如何在C#、TypeScript或JavaScript中编写3D软件渲染引擎中的从Blender加载导出网格这一章节。</p>
<p>我们已经能够在引擎中加载从Blender导出的Json文件了。那么到现在为止，我们的渲染效果依然只是简单的线框渲染。但是，在本章我们将讲解如何使用三角形光栅化算法来填充三角形。然后，我们将使用深度缓冲，以避免在后面的面跑到前面来的问题。</p>
<p>本章教程是以下系列的一部分：</p>
<p><a href="http://blog.csdn.net/teajs/article/details/49989681" target="_blank">1 – 编写相机、网格和设备对象的核心逻辑</a></p>
<p><a href="http://blog.csdn.net/teajs/article/details/49998675" target="_blank">2 – 绘制线段和三角形来获得线框渲染效果</a></p>
<p><a href="http://blog.csdn.net/teajs/article/details/50001659" target="_blank">3 – 加载通过Blender扩展导出JSON格式的网格</a></p>
<p>4 –填充光栅化的三角形并使用深度缓冲（本文）</p>
<p><a href="http://blog.csdn.net/teajs/article/details/50054509" target="_blank">4b – 额外章节：使用技巧和并行处理来提高性能</a></p>
<p><a href="http://blogs.msdn.com/b/davrous/archive/2013/07/03/tutorial-part-5-learning-how-to-write-a-3d-software-engine-in-c-ts-or-js-flat-amp-gouraud-shading.aspx" target="_blank">5 – 使用平面着色和高氏着色处理光 &nbsp;</a></p>
<p><a href="http://blogs.msdn.com/b/davrous/archive/2013/07/18/tutorial-part-6-learning-how-to-write-a-3d-software-engine-in-c-ts-or-js-texture-mapping-back-face-culling-amp-webgl.aspx" target="_blank">6 – 应用纹理、背面剔除以及一些WebGL相关</a></p>
<p>通过本章节，你将能够看到这样的效果：</p>
<p><a href="http://david.blob.core.windows.net/softengine3d/part4/index.html" target="_blank">点击运行</a></p>
<p><strong>光栅化</strong></p>
<p>【译者注：感谢四川-平生小哥为我们翻译此段】</p>
<p>有很多不同类型的光栅化算法。我甚至知道在我的团队中有人向知名的GPU厂商提出了自己的光栅化算法。也多亏了他，我现在知道了什么是<a href="https://en.wikipedia.org/wiki/Boustrophedon" target="_blank">折行书</a>并一直使用至今。 :-)</p>
<p>为了更正规，我们将在本教程中实现一个简单而有效的光栅化算法。正如我们在CPU中运行3D软件渲染引擎一般，它会耗费我们的大量CPU运算。当然，现今这个功能已经直接用GPU来帮我们完成。</p>
<p>先让我们做一个练习。请拿出一张纸，然后画一个三角形，嗯……任意你所能画出来的三角形。我们要找出一个通用的方法可以得出任意类型的三角形。</p>
<p>如果我们按Y轴对每个三角形的三个点进行排序，保证 P1 后面是 P2， 然后是 P3 的话，最终将出现两种可能的情况：</p>
<p><img src="./光栅化三角形_files/2016-03-22_56f0e989ca528.jpg" alt="三角形的两种情况" title="三角形的两种情况"></p>
<p>你将会看到这两种情况：</p>
<p>P2 在 P1 和 P3 的右侧 或 P2在 P1 和 P3 的左侧。在本教程中，由于我们始终是从左到右(sx 到 se)的顺序画线，所以就按照这个假设来处理这两种情况。</p>
<p>此外，我们要顺着左图中的红线自上而下 (从 P1.Y 到 &nbsp;P3.Y) 从左向右绘制。但是当到达P2.Y时我们需要稍微改变一下逻辑，因为这时两种情况的斜率都会发生改变。这就是为什么我们将扫描线处理分为两个步骤：从 P1.Y 向下移动到 P2.Y，然后从P2.Y 最终移动到 P3.Y。</p>
<p>要了解我们使用算法的全部逻辑，可以在维基百科中找到词条：<a href="http://en.wikipedia.org/wiki/Slope" title="http://en.wikipedia.org/wiki/Slope" target="_blank">http://en.wikipedia.org/wiki/Slope</a>。它只是一些基本的数学运算。</p>
<p>为了能够适应这两种情况，你只需要进行简单的运算：</p>
<p>dP1P2 = P2.X - P1.X / P2.Y - P1.Y</p>
<p>dP1P3 = P3.X - P1.X / P3.Y - P1.Y</p>
<p>那我们如何得知是属于哪种情况呢？</p>
<p>P2 在右的第一种情况：dP1P2 &gt; dP1P3</p>
<p>P2 在左的第二种情况：dP1P3 &gt; dP1P2</p>
<p>现在已经有了算法的基本逻辑，我们需要知道如何计算上图中每条线上的 sx(起始的 x 坐标) 和 ex(结束的 x 坐标) 之间的 x。因此要首先计算出 sx 和 ex。由于我们知道当前所扫描到的 y 值、P1P3 和 P1P3 的斜率，因此我们不难得出 sx 和 ex 值。</p>
<p>以情况1为例。首先利用当前的 y 值来计算梯度。它将告诉我们在 P1.Y 和 P2.Y之间进行处理时，我们当前所处的阶段。</p>
<p>梯度 = 当前的y值 - P1.Y / P2.Y - P1.Y</p>
<p>因为 x 和 y 是线性连接，所以我们可以基于该梯度，利用 P1.X 和 P3.X 来计算 sx 插值，并利用 P1.X 和 P2.X来计算 ex 插值。</p>
<p>如果您能够理解插值这个概念，那么你就能够理解剩下所有关于光纤和材质。而且你能够很好的阅读相关代码，也能够从头开始自己重写代码，而无须复制、粘贴下面的代码。</p>
<p>如果还不是很清楚的话，这里有一些关于光栅化的文章以供阅读：</p>
<p><a href="http://www.codeproject.com/Articles/170296/3D-Software-Rendering-Engine-Part-I" target="_blank">- 3D软件渲染引擎 - 第一部分</a></p>
<p><a href="https://lva.cg.tuwien.ac.at/ecg/wiki/doku.php?id=students:fill_rasterization" target="_blank">- 三角形光栅化</a></p>
<p><a href="http://www.sunshine2k.de/coding/java/TriangleRasterization/TriangleRasterization.html" target="_blank">- 填充三角形的软件光栅化算法</a></p>
<p>现在，基于我们现有的算法描述说明让我们开始编写代码。首先，从设备对象删除 drawLine 和 drawBline 函数，并用下面的代码进行替换：</p>
<p>【译者注：C#代码】</p>
<pre><code class="ಠhighlight-container"><span class="token comment">// 将三维坐标和变换矩阵转换成二维坐标  </span>
public Vector3 <span class="token function">Project</span><span class="token punctuation">(</span>Vector3 coord<span class="token punctuation">,</span> Matrix transMat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 进行坐标变换  </span>
    var point <span class="token operator">=</span> Vector3<span class="token punctuation">.</span><span class="token function">TransformCoordinate</span><span class="token punctuation">(</span>coord<span class="token punctuation">,</span> transMat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 变换后的坐标起始点是坐标系的中心点  </span>
    <span class="token comment">// 但是，在屏幕上，我们以左上角为起始点  </span>
    <span class="token comment">// 我们需要重新计算使他们的起始点变成左上角</span>
    var x <span class="token operator">=</span> point<span class="token punctuation">.</span>X <span class="token operator">*</span> bmp<span class="token punctuation">.</span>PixelWidth <span class="token operator">+</span> bmp<span class="token punctuation">.</span>PixelWidth <span class="token operator">/</span> <span class="token number">2.0</span>f<span class="token punctuation">;</span>
    var y <span class="token operator">=</span> <span class="token operator">-</span>point<span class="token punctuation">.</span>Y <span class="token operator">*</span> bmp<span class="token punctuation">.</span>PixelHeight <span class="token operator">+</span> bmp<span class="token punctuation">.</span>PixelHeight <span class="token operator">/</span> <span class="token number">2.0</span>f<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> point<span class="token punctuation">.</span>Z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果二维坐标在可视范围内则绘制</span>
public void <span class="token function">DrawPoint</span><span class="token punctuation">(</span>Vector2 point<span class="token punctuation">,</span> Color4 color<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 判断是否在屏幕内  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span>X <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>Y <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>X <span class="token operator">&lt;</span> bmp<span class="token punctuation">.</span>PixelWidth <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>Y <span class="token operator">&lt;</span> bmp<span class="token punctuation">.</span>PixelHeight<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 绘制一个点</span>
        <span class="token function">PutPixel</span><span class="token punctuation">(</span><span class="token punctuation">(</span>int<span class="token punctuation">)</span>point<span class="token punctuation">.</span>X<span class="token punctuation">,</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span>point<span class="token punctuation">.</span>Y<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>【译者注：TypeScript代码】</p>
<pre><code class="ಠhighlight-container"><span class="token comment">// 将三维坐标和变换矩阵转换成二维坐标</span>
public <span class="token function">project</span><span class="token punctuation">(</span>coord<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">,</span> transMat<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Matrix<span class="token punctuation">)</span><span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3 <span class="token punctuation">{</span>
    <span class="token comment">// 进行坐标变换  </span>
    var point <span class="token operator">=</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">.</span><span class="token function">TransformCoordinates</span><span class="token punctuation">(</span>coord<span class="token punctuation">,</span> transMat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 变换后的坐标起始点是坐标系的中心点  </span>
    <span class="token comment">// 但是，在屏幕上，我们以左上角为起始点  </span>
    <span class="token comment">// 我们需要重新计算使他们的起始点变成左上角</span>
    var x <span class="token operator">=</span> point<span class="token punctuation">.</span>x <span class="token operator">*</span> this<span class="token punctuation">.</span>workingWidth <span class="token operator">+</span> this<span class="token punctuation">.</span>workingWidth <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    var y <span class="token operator">=</span> <span class="token operator">-</span>point<span class="token punctuation">.</span>y <span class="token operator">*</span> this<span class="token punctuation">.</span>workingHeight <span class="token operator">+</span> this<span class="token punctuation">.</span>workingHeight <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BABYLON<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> point<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果二维坐标在可视范围内则绘制</span>
public <span class="token function">drawPoint</span><span class="token punctuation">(</span>point<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector2<span class="token punctuation">,</span> color<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Color4<span class="token punctuation">)</span><span class="token punctuation">:</span> void <span class="token punctuation">{</span>
    <span class="token comment">// 判断是否在屏幕内</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>y <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> this<span class="token punctuation">.</span>workingWidth <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> this<span class="token punctuation">.</span>workingHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 绘制一个点</span>
        this<span class="token punctuation">.</span><span class="token function">putPixel</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x<span class="token punctuation">,</span> point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>【译者注：JavaScript代码】</p>
<pre><code class="ಠhighlight-container"><span class="token comment">// 将三维坐标和变换矩阵转换成二维坐标</span>
Device<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>project <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>coord<span class="token punctuation">,</span> transMat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    var point <span class="token operator">=</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">.</span><span class="token function">TransformCoordinates</span><span class="token punctuation">(</span>coord<span class="token punctuation">,</span> transMat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 变换后的坐标起始点是坐标系的中心点  </span>
    <span class="token comment">// 但是，在屏幕上，我们以左上角为起始点  </span>
    <span class="token comment">// 我们需要重新计算使他们的起始点变成左上角</span>
    var x <span class="token operator">=</span> point<span class="token punctuation">.</span>x <span class="token operator">*</span> this<span class="token punctuation">.</span>workingWidth <span class="token operator">+</span> this<span class="token punctuation">.</span>workingWidth <span class="token operator">/</span> <span class="token number">2.0</span> <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    var y <span class="token operator">=</span> <span class="token operator">-</span>point<span class="token punctuation">.</span>y <span class="token operator">*</span> this<span class="token punctuation">.</span>workingHeight <span class="token operator">+</span> this<span class="token punctuation">.</span>workingHeight <span class="token operator">/</span> <span class="token number">2.0</span> <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BABYLON<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> point<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 如果二维坐标在可视范围内则绘制</span>
Device<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>drawPoint <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>point<span class="token punctuation">,</span> color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断是否在屏幕内</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span>x <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>y <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> this<span class="token punctuation">.</span>workingWidth
                                        <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> this<span class="token punctuation">.</span>workingHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 绘制一个点</span>
        this<span class="token punctuation">.</span><span class="token function">putPixel</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x<span class="token punctuation">,</span> point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>我们仅仅做了一些准备，下面则是最重要的部分，基于先前解释过的三角形的逻辑进行绘制。</p>
<p>【译者注：C#代码】</p>
<pre><code class="ಠhighlight-container"><span class="token comment">// 限制数值范围在0和1之间</span>
float <span class="token function">Clamp</span><span class="token punctuation">(</span>float value<span class="token punctuation">,</span> float min <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> float max <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">Max</span><span class="token punctuation">(</span>min<span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">Min</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 过渡插值</span>
float <span class="token function">Interpolate</span><span class="token punctuation">(</span>float min<span class="token punctuation">,</span> float max<span class="token punctuation">,</span> float gradient<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> min <span class="token operator">+</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">Clamp</span><span class="token punctuation">(</span>gradient<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在两点之间从左到右绘制一条线段</span>
<span class="token comment">// papb -&gt; pcpd</span>
<span class="token comment">// pa, pb, pc, pd在之前必须已经排好序</span>
void <span class="token function">ProcessScanLine</span><span class="token punctuation">(</span>int y<span class="token punctuation">,</span> Vector3 pa<span class="token punctuation">,</span> Vector3 pb<span class="token punctuation">,</span> Vector3 pc<span class="token punctuation">,</span> Vector3 pd<span class="token punctuation">,</span> Color4 color<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 由当前的y值，我们可以计算出梯度</span>
    <span class="token comment">// 以此再计算出 起始X(sx) 和 结束X(ex)</span>
    <span class="token comment">// 如果pa.Y == pb.Y 或者 pc.Y== pd.y的话，梯度强制为1</span>
    var gradient1 <span class="token operator">=</span> pa<span class="token punctuation">.</span>Y <span class="token operator">!=</span> pb<span class="token punctuation">.</span>Y <span class="token operator">?</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> pa<span class="token punctuation">.</span>Y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pb<span class="token punctuation">.</span>Y <span class="token operator">-</span> pa<span class="token punctuation">.</span>Y<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    var gradient2 <span class="token operator">=</span> pc<span class="token punctuation">.</span>Y <span class="token operator">!=</span> pd<span class="token punctuation">.</span>Y <span class="token operator">?</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> pc<span class="token punctuation">.</span>Y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pd<span class="token punctuation">.</span>Y <span class="token operator">-</span> pc<span class="token punctuation">.</span>Y<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>

    int sx <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span><span class="token function">Interpolate</span><span class="token punctuation">(</span>pa<span class="token punctuation">.</span>X<span class="token punctuation">,</span> pb<span class="token punctuation">.</span>X<span class="token punctuation">,</span> gradient1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    int ex <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span><span class="token function">Interpolate</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>X<span class="token punctuation">,</span> pd<span class="token punctuation">.</span>X<span class="token punctuation">,</span> gradient2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从左(sx)向右(ex)绘制一条线</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>var x <span class="token operator">=</span> sx<span class="token punctuation">;</span> x <span class="token operator">&lt;</span> ex<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">DrawPoint</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

public void <span class="token function">DrawTriangle</span><span class="token punctuation">(</span>Vector3 p1<span class="token punctuation">,</span> Vector3 p2<span class="token punctuation">,</span> Vector3 p3<span class="token punctuation">,</span> Color4 color<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 进行排序，p1总在最上面，p2总在最中间，p3总在最下面</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p1<span class="token punctuation">.</span>Y <span class="token operator">&gt;</span> p2<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        var temp <span class="token operator">=</span> p2<span class="token punctuation">;</span>
        p2 <span class="token operator">=</span> p1<span class="token punctuation">;</span>
        p1 <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p2<span class="token punctuation">.</span>Y <span class="token operator">&gt;</span> p3<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        var temp <span class="token operator">=</span> p2<span class="token punctuation">;</span>
        p2 <span class="token operator">=</span> p3<span class="token punctuation">;</span>
        p3 <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p1<span class="token punctuation">.</span>Y <span class="token operator">&gt;</span> p2<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        var temp <span class="token operator">=</span> p2<span class="token punctuation">;</span>
        p2 <span class="token operator">=</span> p1<span class="token punctuation">;</span>
        p1 <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 反向斜率</span>
    float dP1P2<span class="token punctuation">,</span> dP1P3<span class="token punctuation">;</span>

    <span class="token comment">// http://en.wikipedia.org/wiki/Slope</span>
    <span class="token comment">// 计算反向斜率</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p2<span class="token punctuation">.</span>Y <span class="token operator">-</span> p1<span class="token punctuation">.</span>Y <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        dP1P2 <span class="token operator">=</span> <span class="token punctuation">(</span>p2<span class="token punctuation">.</span>X <span class="token operator">-</span> p1<span class="token punctuation">.</span>X<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>p2<span class="token punctuation">.</span>Y <span class="token operator">-</span> p1<span class="token punctuation">.</span>Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        dP1P2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p3<span class="token punctuation">.</span>Y <span class="token operator">-</span> p1<span class="token punctuation">.</span>Y <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        dP1P3 <span class="token operator">=</span> <span class="token punctuation">(</span>p3<span class="token punctuation">.</span>X <span class="token operator">-</span> p1<span class="token punctuation">.</span>X<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>p3<span class="token punctuation">.</span>Y <span class="token operator">-</span> p1<span class="token punctuation">.</span>Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        dP1P3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 对于第一种情况来说，三角形是这样的：</span>
    <span class="token comment">// P1</span>
    <span class="token comment">// -</span>
    <span class="token comment">// -- </span>
    <span class="token comment">// - -</span>
    <span class="token comment">// -  -</span>
    <span class="token comment">// -   - P2</span>
    <span class="token comment">// -  -</span>
    <span class="token comment">// - -</span>
    <span class="token comment">// -</span>
    <span class="token comment">// P3</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dP1P2 <span class="token operator">&gt;</span> dP1P3<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>var y <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span>p1<span class="token punctuation">.</span>Y<span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span>p3<span class="token punctuation">.</span>Y<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> p2<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">ProcessScanLine</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">ProcessScanLine</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 对于第二种情况来说，三角形是这样的：</span>
    <span class="token comment">//       P1</span>
    <span class="token comment">//        -</span>
    <span class="token comment">//       -- </span>
    <span class="token comment">//      - -</span>
    <span class="token comment">//     -  -</span>
    <span class="token comment">// P2 -   - </span>
    <span class="token comment">//     -  -</span>
    <span class="token comment">//      - -</span>
    <span class="token comment">//        -</span>
    <span class="token comment">//       P3</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>var y <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span>p1<span class="token punctuation">.</span>Y<span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span>p3<span class="token punctuation">.</span>Y<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> p2<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">ProcessScanLine</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">ProcessScanLine</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>【译者注：TypeScript代码】</p>
<pre><code class="ಠhighlight-container"><span class="token comment">// 限制数值范围在0和1之间</span>
public <span class="token function">clamp</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> number<span class="token punctuation">,</span> min<span class="token punctuation">:</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> number <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span> number <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>min<span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 过渡插值</span>
public <span class="token function">interpolate</span><span class="token punctuation">(</span>min<span class="token punctuation">:</span> number<span class="token punctuation">,</span> max<span class="token punctuation">:</span> number<span class="token punctuation">,</span> gradient<span class="token punctuation">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> min <span class="token operator">+</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min<span class="token punctuation">)</span> <span class="token operator">*</span> this<span class="token punctuation">.</span><span class="token function">clamp</span><span class="token punctuation">(</span>gradient<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在两点之间从左到右绘制一条线段</span>
<span class="token comment">// papb -&gt; pcpd</span>
<span class="token comment">// pa, pb, pc, pd在之前必须已经排好序</span>
public <span class="token function">processScanLine</span><span class="token punctuation">(</span>y<span class="token punctuation">:</span> number<span class="token punctuation">,</span> pa<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">,</span> pb<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">,</span> 
                       pc<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">,</span> pd<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">,</span> color<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Color4<span class="token punctuation">)</span><span class="token punctuation">:</span> void <span class="token punctuation">{</span>
    <span class="token comment">// 由当前的y值，我们可以计算出梯度</span>
    <span class="token comment">// 以此再计算出 起始X(sx) 和 结束X(ex)</span>
    <span class="token comment">// 如果pa.Y == pb.Y 或者 pc.Y== pd.y的话，梯度强制为1</span>
    var gradient1 <span class="token operator">=</span> pa<span class="token punctuation">.</span>y <span class="token operator">!=</span> pb<span class="token punctuation">.</span>y <span class="token operator">?</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> pa<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pb<span class="token punctuation">.</span>y <span class="token operator">-</span> pa<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    var gradient2 <span class="token operator">=</span> pc<span class="token punctuation">.</span>y <span class="token operator">!=</span> pd<span class="token punctuation">.</span>y <span class="token operator">?</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> pc<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pd<span class="token punctuation">.</span>y <span class="token operator">-</span> pc<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>

    var sx <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>pa<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pb<span class="token punctuation">.</span>x<span class="token punctuation">,</span> gradient1<span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    var ex <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pd<span class="token punctuation">.</span>x<span class="token punctuation">,</span> gradient2<span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 从左(sx)向右(ex)绘制一条线</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>var x <span class="token operator">=</span> sx<span class="token punctuation">;</span> x <span class="token operator">&lt;</span> ex<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        this<span class="token punctuation">.</span><span class="token function">drawPoint</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BABYLON<span class="token punctuation">.</span>Vector2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

public <span class="token function">drawTriangle</span><span class="token punctuation">(</span>p1<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">,</span> p2<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">,</span> 
                    p3<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">,</span> color<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Color4<span class="token punctuation">)</span><span class="token punctuation">:</span> void <span class="token punctuation">{</span>
    <span class="token comment">// 进行排序，p1总在最上面，p2总在最中间，p3总在最下面</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p1<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> p2<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var temp <span class="token operator">=</span> p2<span class="token punctuation">;</span>
        p2 <span class="token operator">=</span> p1<span class="token punctuation">;</span>
        p1 <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p2<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> p3<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var temp <span class="token operator">=</span> p2<span class="token punctuation">;</span>
        p2 <span class="token operator">=</span> p3<span class="token punctuation">;</span>
        p3 <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p1<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> p2<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var temp <span class="token operator">=</span> p2<span class="token punctuation">;</span>
        p2 <span class="token operator">=</span> p1<span class="token punctuation">;</span>
        p1 <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 反向斜率</span>
    var dP1P2<span class="token punctuation">:</span> number<span class="token punctuation">;</span> var dP1P3<span class="token punctuation">:</span> number<span class="token punctuation">;</span>

    <span class="token comment">// http://en.wikipedia.org/wiki/Slope</span>
    <span class="token comment">// 计算反向斜率</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p2<span class="token punctuation">.</span>y <span class="token operator">-</span> p1<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        dP1P2 <span class="token operator">=</span> <span class="token punctuation">(</span>p2<span class="token punctuation">.</span>x <span class="token operator">-</span> p1<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>p2<span class="token punctuation">.</span>y <span class="token operator">-</span> p1<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        dP1P2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p3<span class="token punctuation">.</span>y <span class="token operator">-</span> p1<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        dP1P3 <span class="token operator">=</span> <span class="token punctuation">(</span>p3<span class="token punctuation">.</span>x <span class="token operator">-</span> p1<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>p3<span class="token punctuation">.</span>y <span class="token operator">-</span> p1<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        dP1P3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 对于第一种情况来说，三角形是这样的：</span>
    <span class="token comment">// P1</span>
    <span class="token comment">// -</span>
    <span class="token comment">// -- </span>
    <span class="token comment">// - -</span>
    <span class="token comment">// -  -</span>
    <span class="token comment">// -   - P2</span>
    <span class="token comment">// -  -</span>
    <span class="token comment">// - -</span>
    <span class="token comment">// -</span>
    <span class="token comment">// P3</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dP1P2 <span class="token operator">&gt;</span> dP1P3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>var y <span class="token operator">=</span> p1<span class="token punctuation">.</span>y <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> p3<span class="token punctuation">.</span>y <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> p2<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                this<span class="token punctuation">.</span><span class="token function">processScanLine</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                this<span class="token punctuation">.</span><span class="token function">processScanLine</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 对于第二种情况来说，三角形是这样的：</span>
    <span class="token comment">//       P1</span>
    <span class="token comment">//        -</span>
    <span class="token comment">//       -- </span>
    <span class="token comment">//      - -</span>
    <span class="token comment">//     -  -</span>
    <span class="token comment">// P2 -   - </span>
    <span class="token comment">//     -  -</span>
    <span class="token comment">//      - -</span>
    <span class="token comment">//        -</span>
    <span class="token comment">//       P3</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>var y <span class="token operator">=</span> p1<span class="token punctuation">.</span>y <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> p3<span class="token punctuation">.</span>y <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> p2<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                this<span class="token punctuation">.</span><span class="token function">processScanLine</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                this<span class="token punctuation">.</span><span class="token function">processScanLine</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p>【译者注：JavaScript代码】</p>
<pre><code class="ಠhighlight-container"><span class="token comment">// 限制数值范围在0和1之间</span>
Device<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>clamp <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> min<span class="token punctuation">,</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>typeof min <span class="token operator">===</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> min <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>typeof max <span class="token operator">===</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> max <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>min<span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 过渡插值</span>
Device<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>interpolate <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>min<span class="token punctuation">,</span> max<span class="token punctuation">,</span> gradient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> min <span class="token operator">+</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min<span class="token punctuation">)</span> <span class="token operator">*</span> this<span class="token punctuation">.</span><span class="token function">clamp</span><span class="token punctuation">(</span>gradient<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 在两点之间从左到右绘制一条线段</span>
<span class="token comment">// papb -&gt; pcpd</span>
<span class="token comment">// pa, pb, pc, pd在之前必须已经排好序</span>
Device<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>processScanLine <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>y<span class="token punctuation">,</span> pa<span class="token punctuation">,</span> pb<span class="token punctuation">,</span> pc<span class="token punctuation">,</span> pd<span class="token punctuation">,</span> color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 由当前的y值，我们可以计算出梯度</span>
    <span class="token comment">// 以此再计算出 起始X(sx) 和 结束X(ex)</span>
    <span class="token comment">// 如果pa.Y == pb.Y 或者 pc.Y== pd.y的话，梯度强制为1</span>
    var gradient1 <span class="token operator">=</span> pa<span class="token punctuation">.</span>y <span class="token operator">!=</span> pb<span class="token punctuation">.</span>y <span class="token operator">?</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> pa<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pb<span class="token punctuation">.</span>y <span class="token operator">-</span> pa<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    var gradient2 <span class="token operator">=</span> pc<span class="token punctuation">.</span>y <span class="token operator">!=</span> pd<span class="token punctuation">.</span>y <span class="token operator">?</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> pc<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pd<span class="token punctuation">.</span>y <span class="token operator">-</span> pc<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>

    var sx <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>pa<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pb<span class="token punctuation">.</span>x<span class="token punctuation">,</span> gradient1<span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    var ex <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pd<span class="token punctuation">.</span>x<span class="token punctuation">,</span> gradient2<span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 从左(sx)向右(ex)绘制一条线</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>var x <span class="token operator">=</span> sx<span class="token punctuation">;</span> x <span class="token operator">&lt;</span> ex<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        this<span class="token punctuation">.</span><span class="token function">drawPoint</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BABYLON<span class="token punctuation">.</span>Vector2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Device<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>drawTriangle <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 进行排序，p1总在最上面，p2总在最中间，p3总在最下面</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p1<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> p2<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var temp <span class="token operator">=</span> p2<span class="token punctuation">;</span>
        p2 <span class="token operator">=</span> p1<span class="token punctuation">;</span>
        p1 <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p2<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> p3<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var temp <span class="token operator">=</span> p2<span class="token punctuation">;</span>
        p2 <span class="token operator">=</span> p3<span class="token punctuation">;</span>
        p3 <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p1<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> p2<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var temp <span class="token operator">=</span> p2<span class="token punctuation">;</span>
        p2 <span class="token operator">=</span> p1<span class="token punctuation">;</span>
        p1 <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 反向斜率</span>
    var dP1P2<span class="token punctuation">;</span> var dP1P3<span class="token punctuation">;</span>

    <span class="token comment">// http://en.wikipedia.org/wiki/Slope</span>
    <span class="token comment">// 计算反向斜率</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p2<span class="token punctuation">.</span>y <span class="token operator">-</span> p1<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dP1P2 <span class="token operator">=</span> <span class="token punctuation">(</span>p2<span class="token punctuation">.</span>x <span class="token operator">-</span> p1<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>p2<span class="token punctuation">.</span>y <span class="token operator">-</span> p1<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        dP1P2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p3<span class="token punctuation">.</span>y <span class="token operator">-</span> p1<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dP1P3 <span class="token operator">=</span> <span class="token punctuation">(</span>p3<span class="token punctuation">.</span>x <span class="token operator">-</span> p1<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>p3<span class="token punctuation">.</span>y <span class="token operator">-</span> p1<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        dP1P3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 对于第一种情况来说，三角形是这样的：</span>
    <span class="token comment">// P1</span>
    <span class="token comment">// -</span>
    <span class="token comment">// -- </span>
    <span class="token comment">// - -</span>
    <span class="token comment">// -  -</span>
    <span class="token comment">// -   - P2</span>
    <span class="token comment">// -  -</span>
    <span class="token comment">// - -</span>
    <span class="token comment">// -</span>
    <span class="token comment">// P3</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dP1P2 <span class="token operator">&gt;</span> dP1P3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>var y <span class="token operator">=</span> p1<span class="token punctuation">.</span>y <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> p3<span class="token punctuation">.</span>y <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> p2<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                this<span class="token punctuation">.</span><span class="token function">processScanLine</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                this<span class="token punctuation">.</span><span class="token function">processScanLine</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
        <span class="token comment">// 对于第二种情况来说，三角形是这样的：</span>
        <span class="token comment">//       P1</span>
        <span class="token comment">//        -</span>
        <span class="token comment">//       -- </span>
        <span class="token comment">//      - -</span>
        <span class="token comment">//     -  -</span>
        <span class="token comment">// P2 -   - </span>
        <span class="token comment">//     -  -</span>
        <span class="token comment">//      - -</span>
        <span class="token comment">//        -</span>
        <span class="token comment">//       P3</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>var y <span class="token operator">=</span> p1<span class="token punctuation">.</span>y <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> p3<span class="token punctuation">.</span>y <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> p2<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                this<span class="token punctuation">.</span><span class="token function">processScanLine</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                this<span class="token punctuation">.</span><span class="token function">processScanLine</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre>
<p>你已经了解了如何处理两种三角形的填写以及扫描线中所做的操作了。</p>
<p>最后，你需要更新渲染函数，用drawTriangle来替代drawLine和drawBline。我们还用了不同的灰色填充每个三角形。不然的话，整个画面一片灰你根本就看不出效果来。我们将在接下来的教程中学习到如何恰当的处理光照。</p>
<p>【译者注：C#代码】</p>
<pre><code class="ಠhighlight-container">var faceIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
foreach <span class="token punctuation">(</span>var face <span class="token keyword">in</span> mesh<span class="token punctuation">.</span>Faces<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    var vertexA <span class="token operator">=</span> mesh<span class="token punctuation">.</span>Vertices<span class="token punctuation">[</span>face<span class="token punctuation">.</span>A<span class="token punctuation">]</span><span class="token punctuation">;</span>
    var vertexB <span class="token operator">=</span> mesh<span class="token punctuation">.</span>Vertices<span class="token punctuation">[</span>face<span class="token punctuation">.</span>B<span class="token punctuation">]</span><span class="token punctuation">;</span>
    var vertexC <span class="token operator">=</span> mesh<span class="token punctuation">.</span>Vertices<span class="token punctuation">[</span>face<span class="token punctuation">.</span>C<span class="token punctuation">]</span><span class="token punctuation">;</span>

    var pixelA <span class="token operator">=</span> <span class="token function">Project</span><span class="token punctuation">(</span>vertexA<span class="token punctuation">,</span> transformMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    var pixelB <span class="token operator">=</span> <span class="token function">Project</span><span class="token punctuation">(</span>vertexB<span class="token punctuation">,</span> transformMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    var pixelC <span class="token operator">=</span> <span class="token function">Project</span><span class="token punctuation">(</span>vertexC<span class="token punctuation">,</span> transformMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>

    var color <span class="token operator">=</span> <span class="token number">0.25</span>f <span class="token operator">+</span> <span class="token punctuation">(</span>faceIndex <span class="token operator">%</span> mesh<span class="token punctuation">.</span>Faces<span class="token punctuation">.</span>Length<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.75</span>f <span class="token operator">/</span> mesh<span class="token punctuation">.</span>Faces<span class="token punctuation">.</span>Length<span class="token punctuation">;</span>
    <span class="token function">DrawTriangle</span><span class="token punctuation">(</span>pixelA<span class="token punctuation">,</span> pixelB<span class="token punctuation">,</span> pixelC<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Color4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> color<span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    faceIndex<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>【译者注：TypeScript代码】</p>
<pre><code class="ಠhighlight-container"><span class="token keyword">for</span> <span class="token punctuation">(</span>var indexFaces <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> indexFaces <span class="token operator">&lt;</span> cMesh<span class="token punctuation">.</span>Faces<span class="token punctuation">.</span>length<span class="token punctuation">;</span> indexFaces<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    var currentFace <span class="token operator">=</span> cMesh<span class="token punctuation">.</span>Faces<span class="token punctuation">[</span>indexFaces<span class="token punctuation">]</span><span class="token punctuation">;</span>
    var vertexA <span class="token operator">=</span> cMesh<span class="token punctuation">.</span>Vertices<span class="token punctuation">[</span>currentFace<span class="token punctuation">.</span>A<span class="token punctuation">]</span><span class="token punctuation">;</span>
    var vertexB <span class="token operator">=</span> cMesh<span class="token punctuation">.</span>Vertices<span class="token punctuation">[</span>currentFace<span class="token punctuation">.</span>B<span class="token punctuation">]</span><span class="token punctuation">;</span>
    var vertexC <span class="token operator">=</span> cMesh<span class="token punctuation">.</span>Vertices<span class="token punctuation">[</span>currentFace<span class="token punctuation">.</span>C<span class="token punctuation">]</span><span class="token punctuation">;</span>

    var pixelA <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">project</span><span class="token punctuation">(</span>vertexA<span class="token punctuation">,</span> transformMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    var pixelB <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">project</span><span class="token punctuation">(</span>vertexB<span class="token punctuation">,</span> transformMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    var pixelC <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">project</span><span class="token punctuation">(</span>vertexC<span class="token punctuation">,</span> transformMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>

    var color<span class="token punctuation">:</span> number <span class="token operator">=</span> <span class="token number">0.25</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>indexFaces <span class="token operator">%</span> cMesh<span class="token punctuation">.</span>Faces<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">/</span> cMesh<span class="token punctuation">.</span>Faces<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.75</span><span class="token punctuation">;</span>
    this<span class="token punctuation">.</span><span class="token function">drawTriangle</span><span class="token punctuation">(</span>pixelA<span class="token punctuation">,</span> pixelB<span class="token punctuation">,</span> pixelC<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BABYLON<span class="token punctuation">.</span>Color4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> color<span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>【译者注：JavaScript代码】</p>
<pre><code class="ಠhighlight-container"><span class="token keyword">for</span> <span class="token punctuation">(</span>var indexFaces <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> indexFaces <span class="token operator">&lt;</span> cMesh<span class="token punctuation">.</span>Faces<span class="token punctuation">.</span>length<span class="token punctuation">;</span> indexFaces<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    var currentFace <span class="token operator">=</span> cMesh<span class="token punctuation">.</span>Faces<span class="token punctuation">[</span>indexFaces<span class="token punctuation">]</span><span class="token punctuation">;</span>
    var vertexA <span class="token operator">=</span> cMesh<span class="token punctuation">.</span>Vertices<span class="token punctuation">[</span>currentFace<span class="token punctuation">.</span>A<span class="token punctuation">]</span><span class="token punctuation">;</span>
    var vertexB <span class="token operator">=</span> cMesh<span class="token punctuation">.</span>Vertices<span class="token punctuation">[</span>currentFace<span class="token punctuation">.</span>B<span class="token punctuation">]</span><span class="token punctuation">;</span>
    var vertexC <span class="token operator">=</span> cMesh<span class="token punctuation">.</span>Vertices<span class="token punctuation">[</span>currentFace<span class="token punctuation">.</span>C<span class="token punctuation">]</span><span class="token punctuation">;</span>

    var pixelA <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">project</span><span class="token punctuation">(</span>vertexA<span class="token punctuation">,</span> transformMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    var pixelB <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">project</span><span class="token punctuation">(</span>vertexB<span class="token punctuation">,</span> transformMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    var pixelC <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">project</span><span class="token punctuation">(</span>vertexC<span class="token punctuation">,</span> transformMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>

    var color <span class="token operator">=</span> <span class="token number">0.25</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>indexFaces <span class="token operator">%</span> cMesh<span class="token punctuation">.</span>Faces<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">/</span> cMesh<span class="token punctuation">.</span>Faces<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.75</span><span class="token punctuation">;</span>
    this<span class="token punctuation">.</span><span class="token function">drawTriangle</span><span class="token punctuation">(</span>pixelA<span class="token punctuation">,</span> pixelB<span class="token punctuation">,</span> pixelC<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BABYLON<span class="token punctuation">.</span>Color4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> color<span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>结果应该是这样的：</p>
<p><a href="http://david.blob.core.windows.net/softengine3d/part4sample1/index.html" target="_blank">运行代码</a></p>
<p>这是怎么回事？为什么感觉这么奇怪？！嗯~这是因为我们没有正确的把正面的三角形画在正面。【译者注：我是这么翻译的，你就这么一看~】</p>
<p>如何使用深度缓冲</p>
<p>我们需要对当前的Z值在缓冲区中进行比较。</p>
<p>如果当前要绘制的像素Z值是最前面的（最靠近屏幕），则可以绘制。</p>
<p>然而，如果当前Z值大于前面的像素，则可以被丢弃。</p>
<p>我们需要一个东西用来保存深度缓冲区。因此，我们声明一个新的数组，并将其命名为深度缓冲区(depthBuffer)。该数组的大小等于 屏幕(width * height)。</p>
<p>每次调用 clear() 函数时深度缓冲区内的每一个元素都需要一个非常高的默认Z值。</p>
<p>在putPixel(函数/方法)中，我们需要测试已存储在缓冲区中某个指定的像素Z值。此外，我们以前的逻辑接收Vector2用于绘制在屏幕上。现在我们将其改为Vector3用于增加Z值。因为现在我们将需要这部分新信息用于正确绘制面片。</p>
<p>最后，在我们的三角形内，同样需要一个类似 x 值插值的方式对 z 值进行插值。</p>
<p>总之，这里是你所需要对设备对象更新的代码：</p>
<p>【译者注：C#代码】</p>
<pre><code class="ಠhighlight-container">private byte<span class="token punctuation">[</span><span class="token punctuation">]</span> backBuffer<span class="token punctuation">;</span>
private readonly float<span class="token punctuation">[</span><span class="token punctuation">]</span> depthBuffer<span class="token punctuation">;</span>
private WriteableBitmap bmp<span class="token punctuation">;</span>
private readonly int renderWidth<span class="token punctuation">;</span>
private readonly int renderHeight<span class="token punctuation">;</span>

public <span class="token function">Device</span><span class="token punctuation">(</span>WriteableBitmap bmp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    this<span class="token punctuation">.</span>bmp <span class="token operator">=</span> bmp<span class="token punctuation">;</span>
    renderWidth <span class="token operator">=</span> bmp<span class="token punctuation">.</span>PixelWidth<span class="token punctuation">;</span>
    renderHeight <span class="token operator">=</span> bmp<span class="token punctuation">.</span>PixelHeight<span class="token punctuation">;</span>

    <span class="token comment">// 后台缓冲区大小值是要绘制的像素  </span>
    <span class="token comment">// 屏幕(width*height) * 4 (R,G,B &amp; Alpha值) </span>
    backBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>bmp<span class="token punctuation">.</span>PixelWidth <span class="token operator">*</span> bmp<span class="token punctuation">.</span>PixelHeight <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    depthBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">float</span><span class="token punctuation">[</span>bmp<span class="token punctuation">.</span>PixelWidth <span class="token operator">*</span> bmp<span class="token punctuation">.</span>PixelHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 清除后台缓冲区为指定颜色 </span>
public void <span class="token function">Clear</span><span class="token punctuation">(</span>byte r<span class="token punctuation">,</span> byte g<span class="token punctuation">,</span> byte b<span class="token punctuation">,</span> byte a<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 清除后台缓冲区</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>var index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> backBuffer<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> index <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Windows使用BGRA，而不是Html5中使用的RGBA </span>
        backBuffer<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">;</span>
        backBuffer<span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> g<span class="token punctuation">;</span>
        backBuffer<span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">;</span>
        backBuffer<span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 清除深度缓冲区</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>var index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> depthBuffer<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        depthBuffer<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> float<span class="token punctuation">.</span>MaxValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 调用此方法把一个像素绘制到指定的X, Y坐标上  </span>
public void <span class="token function">PutPixel</span><span class="token punctuation">(</span>int x<span class="token punctuation">,</span> int y<span class="token punctuation">,</span> float z<span class="token punctuation">,</span> Color4 color<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 我们的后台缓冲区是一维数组  </span>
    <span class="token comment">// 这里我们简单计算，将X和Y对应到此一维数组中  </span>
    var index <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> y <span class="token operator">*</span> renderWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    var index4 <span class="token operator">=</span> index <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>depthBuffer<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">&lt;</span> z<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 深度测试不通过</span>
    <span class="token punctuation">}</span>

    depthBuffer<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> z<span class="token punctuation">;</span>

    backBuffer<span class="token punctuation">[</span>index4<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>byte<span class="token punctuation">)</span><span class="token punctuation">(</span>color<span class="token punctuation">.</span>Blue <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    backBuffer<span class="token punctuation">[</span>index4 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>byte<span class="token punctuation">)</span><span class="token punctuation">(</span>color<span class="token punctuation">.</span>Green <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    backBuffer<span class="token punctuation">[</span>index4 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>byte<span class="token punctuation">)</span><span class="token punctuation">(</span>color<span class="token punctuation">.</span>Red <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    backBuffer<span class="token punctuation">[</span>index4 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>byte<span class="token punctuation">)</span><span class="token punctuation">(</span>color<span class="token punctuation">.</span>Alpha <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将三维坐标和变换矩阵转换成二维坐标  </span>
public Vector3 <span class="token function">Project</span><span class="token punctuation">(</span>Vector3 coord<span class="token punctuation">,</span> Matrix transMat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 进行坐标变换  </span>
    var point <span class="token operator">=</span> Vector3<span class="token punctuation">.</span><span class="token function">TransformCoordinate</span><span class="token punctuation">(</span>coord<span class="token punctuation">,</span> transMat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 变换后的坐标起始点是坐标系的中心点  </span>
    <span class="token comment">// 但是，在屏幕上，我们以左上角为起始点  </span>
    <span class="token comment">// 我们需要重新计算使他们的起始点变成左上角 </span>
    var x <span class="token operator">=</span> point<span class="token punctuation">.</span>X <span class="token operator">*</span> bmp<span class="token punctuation">.</span>PixelWidth <span class="token operator">+</span> bmp<span class="token punctuation">.</span>PixelWidth <span class="token operator">/</span> <span class="token number">2.0</span>f<span class="token punctuation">;</span>
    var y <span class="token operator">=</span> <span class="token operator">-</span>point<span class="token punctuation">.</span>Y <span class="token operator">*</span> bmp<span class="token punctuation">.</span>PixelHeight <span class="token operator">+</span> bmp<span class="token punctuation">.</span>PixelHeight <span class="token operator">/</span> <span class="token number">2.0</span>f<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> point<span class="token punctuation">.</span>Z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果二维坐标在可视范围内则绘制 </span>
public void <span class="token function">DrawPoint</span><span class="token punctuation">(</span>Vector3 point<span class="token punctuation">,</span> Color4 color<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 判断是否在屏幕内 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span>X <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>Y <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>X <span class="token operator">&lt;</span> bmp<span class="token punctuation">.</span>PixelWidth <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>Y <span class="token operator">&lt;</span> bmp<span class="token punctuation">.</span>PixelHeight<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 绘制一个点</span>
        <span class="token function">PutPixel</span><span class="token punctuation">(</span><span class="token punctuation">(</span>int<span class="token punctuation">)</span>point<span class="token punctuation">.</span>X<span class="token punctuation">,</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span>point<span class="token punctuation">.</span>Y<span class="token punctuation">,</span> point<span class="token punctuation">.</span>Z<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在两点之间从左到右绘制一条线段</span>
<span class="token comment">// papb -&gt; pcpd</span>
<span class="token comment">// pa, pb, pc, pd在之前必须已经排好序</span>
void <span class="token function">ProcessScanLine</span><span class="token punctuation">(</span>int y<span class="token punctuation">,</span> Vector3 pa<span class="token punctuation">,</span> Vector3 pb<span class="token punctuation">,</span> Vector3 pc<span class="token punctuation">,</span> Vector3 pd<span class="token punctuation">,</span> Color4 color<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 由当前的y值，我们可以计算出梯度</span>
    <span class="token comment">// 以此再计算出 起始X(sx) 和 结束X(ex)</span>
    <span class="token comment">// 如果pa.Y == pb.Y 或者 pc.Y== pd.y的话，梯度强制为1</span>
    var gradient1 <span class="token operator">=</span> pa<span class="token punctuation">.</span>Y <span class="token operator">!=</span> pb<span class="token punctuation">.</span>Y <span class="token operator">?</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> pa<span class="token punctuation">.</span>Y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pb<span class="token punctuation">.</span>Y <span class="token operator">-</span> pa<span class="token punctuation">.</span>Y<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    var gradient2 <span class="token operator">=</span> pc<span class="token punctuation">.</span>Y <span class="token operator">!=</span> pd<span class="token punctuation">.</span>Y <span class="token operator">?</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> pc<span class="token punctuation">.</span>Y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pd<span class="token punctuation">.</span>Y <span class="token operator">-</span> pc<span class="token punctuation">.</span>Y<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>

    int sx <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span><span class="token function">Interpolate</span><span class="token punctuation">(</span>pa<span class="token punctuation">.</span>X<span class="token punctuation">,</span> pb<span class="token punctuation">.</span>X<span class="token punctuation">,</span> gradient1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    int ex <span class="token operator">=</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span><span class="token function">Interpolate</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>X<span class="token punctuation">,</span> pd<span class="token punctuation">.</span>X<span class="token punctuation">,</span> gradient2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 计算 开始Z值 和 结束Z值</span>
    float z1 <span class="token operator">=</span> <span class="token function">Interpolate</span><span class="token punctuation">(</span>pa<span class="token punctuation">.</span>Z<span class="token punctuation">,</span> pb<span class="token punctuation">.</span>Z<span class="token punctuation">,</span> gradient1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float z2 <span class="token operator">=</span> <span class="token function">Interpolate</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>Z<span class="token punctuation">,</span> pd<span class="token punctuation">.</span>Z<span class="token punctuation">,</span> gradient2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从左(sx)向右(ex)绘制一条线</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>var x <span class="token operator">=</span> sx<span class="token punctuation">;</span> x <span class="token operator">&lt;</span> ex<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        float gradient <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> sx<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>float<span class="token punctuation">)</span><span class="token punctuation">(</span>ex <span class="token operator">-</span> sx<span class="token punctuation">)</span><span class="token punctuation">;</span>

        var z <span class="token operator">=</span> <span class="token function">Interpolate</span><span class="token punctuation">(</span>z1<span class="token punctuation">,</span> z2<span class="token punctuation">,</span> gradient<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">DrawPoint</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>【译者注：TypeScript代码】</p>
<pre><code class="ಠhighlight-container"><span class="token comment">// 后台缓冲区大小值是要绘制的像素  </span>
<span class="token comment">// 屏幕(width*height) * 4 (R,G,B &amp; Alpha值) </span>
private backbuffer<span class="token punctuation">:</span> ImageData<span class="token punctuation">;</span>
private workingCanvas<span class="token punctuation">:</span> HTMLCanvasElement<span class="token punctuation">;</span>
private workingContext<span class="token punctuation">:</span> CanvasRenderingContext2D<span class="token punctuation">;</span>
private workingWidth<span class="token punctuation">:</span> number<span class="token punctuation">;</span>
private workingHeight<span class="token punctuation">:</span> number<span class="token punctuation">;</span>
<span class="token comment">// 等同于backbuffer.data</span>
private backbufferdata<span class="token punctuation">;</span>
private depthbuffer<span class="token punctuation">:</span> number<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token function">constructor</span><span class="token punctuation">(</span>canvas<span class="token punctuation">:</span> HTMLCanvasElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    this<span class="token punctuation">.</span>workingCanvas <span class="token operator">=</span> canvas<span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>workingWidth <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>workingHeight <span class="token operator">=</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>workingContext <span class="token operator">=</span> this<span class="token punctuation">.</span>workingCanvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"2d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>depthbuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>this<span class="token punctuation">.</span>workingWidth <span class="token operator">*</span> this<span class="token punctuation">.</span>workingHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 用指定颜色清除后台缓冲区</span>
public <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> void <span class="token punctuation">{</span>
    <span class="token comment">// 使用默认颜色清除后台缓冲区</span>
    this<span class="token punctuation">.</span>workingContext<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> this<span class="token punctuation">.</span>workingWidth<span class="token punctuation">,</span> this<span class="token punctuation">.</span>workingHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 缓存后台缓冲区</span>
    this<span class="token punctuation">.</span>backbuffer <span class="token operator">=</span> this<span class="token punctuation">.</span>workingContext<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> this<span class="token punctuation">.</span>workingWidth<span class="token punctuation">,</span> this<span class="token punctuation">.</span>workingHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 清除深度缓冲区</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>var i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> this<span class="token punctuation">.</span>depthbuffer<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用最大值填充</span>
        this<span class="token punctuation">.</span>depthbuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10000000</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 调用此方法把一个像素绘制到指定的X, Y坐标上 </span>
public <span class="token function">putPixel</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> number<span class="token punctuation">,</span> y<span class="token punctuation">:</span> number<span class="token punctuation">,</span> z<span class="token punctuation">:</span> number<span class="token punctuation">,</span> color<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Color4<span class="token punctuation">)</span><span class="token punctuation">:</span> void <span class="token punctuation">{</span>
    this<span class="token punctuation">.</span>backbufferdata <span class="token operator">=</span> this<span class="token punctuation">.</span>backbuffer<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token comment">// 我们的后台缓冲区是一维数组  </span>
    <span class="token comment">// 这里我们简单计算，将X和Y对应到此一维数组中  </span>
    var index<span class="token punctuation">:</span> number <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> this<span class="token punctuation">.</span>workingWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    var index4<span class="token punctuation">:</span> number <span class="token operator">=</span> index <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>this<span class="token punctuation">.</span>depthbuffer<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">&lt;</span> z<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 深度测试不通过</span>
    <span class="token punctuation">}</span>

    this<span class="token punctuation">.</span>depthbuffer<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> z<span class="token punctuation">;</span>

    <span class="token comment">// 在Html5 canvas中使用RGBA颜色空间  </span>
    this<span class="token punctuation">.</span>backbufferdata<span class="token punctuation">[</span>index4<span class="token punctuation">]</span> <span class="token operator">=</span> color<span class="token punctuation">.</span>r <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>backbufferdata<span class="token punctuation">[</span>index4 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> color<span class="token punctuation">.</span>g <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>backbufferdata<span class="token punctuation">[</span>index4 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> color<span class="token punctuation">.</span>b <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>backbufferdata<span class="token punctuation">[</span>index4 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> color<span class="token punctuation">.</span>a <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将三维坐标和变换矩阵转换成二维坐标 </span>
public <span class="token function">project</span><span class="token punctuation">(</span>coord<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">,</span> transMat<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Matrix<span class="token punctuation">)</span><span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3 <span class="token punctuation">{</span>
    <span class="token comment">// 进行坐标变换  </span>
    var point <span class="token operator">=</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">.</span><span class="token function">TransformCoordinates</span><span class="token punctuation">(</span>coord<span class="token punctuation">,</span> transMat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 变换后的坐标起始点是坐标系的中心点  </span>
    <span class="token comment">// 但是，在屏幕上，我们以左上角为起始点  </span>
    <span class="token comment">// 我们需要重新计算使他们的起始点变成左上角  </span>
    var x <span class="token operator">=</span> point<span class="token punctuation">.</span>x <span class="token operator">*</span> this<span class="token punctuation">.</span>workingWidth <span class="token operator">+</span> this<span class="token punctuation">.</span>workingWidth <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    var y <span class="token operator">=</span> <span class="token operator">-</span>point<span class="token punctuation">.</span>y <span class="token operator">*</span> this<span class="token punctuation">.</span>workingHeight <span class="token operator">+</span> this<span class="token punctuation">.</span>workingHeight <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BABYLON<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> point<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果二维坐标在可视范围内则绘制  </span>
public <span class="token function">drawPoint</span><span class="token punctuation">(</span>point<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">,</span> color<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Color4<span class="token punctuation">)</span><span class="token punctuation">:</span> void <span class="token punctuation">{</span>
    <span class="token comment">// 判断是否在屏幕内  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span>x <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>y <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> this<span class="token punctuation">.</span>workingWidth <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> this<span class="token punctuation">.</span>workingHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 绘制一个点</span>
        this<span class="token punctuation">.</span><span class="token function">putPixel</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x<span class="token punctuation">,</span> point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> point<span class="token punctuation">.</span>z<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在两点之间从左到右绘制一条线段</span>
<span class="token comment">// papb -&gt; pcpd</span>
<span class="token comment">// pa, pb, pc, pd在之前必须已经排好序</span>
public <span class="token function">processScanLine</span><span class="token punctuation">(</span>y<span class="token punctuation">:</span> number<span class="token punctuation">,</span> pa<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">,</span> pb<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">,</span> pc<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">,</span> pd<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">,</span> color<span class="token punctuation">:</span> BABYLON<span class="token punctuation">.</span>Color4<span class="token punctuation">)</span><span class="token punctuation">:</span> void <span class="token punctuation">{</span>
    <span class="token comment">// 由当前的y值，我们可以计算出梯度</span>
    <span class="token comment">// 以此再计算出 起始X(sx) 和 结束X(ex)</span>
    <span class="token comment">// 如果pa.Y == pb.Y 或者 pc.Y== pd.y的话，梯度强制为1</span>
    var gradient1 <span class="token operator">=</span> pa<span class="token punctuation">.</span>y <span class="token operator">!=</span> pb<span class="token punctuation">.</span>y <span class="token operator">?</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> pa<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pb<span class="token punctuation">.</span>y <span class="token operator">-</span> pa<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    var gradient2 <span class="token operator">=</span> pc<span class="token punctuation">.</span>y <span class="token operator">!=</span> pd<span class="token punctuation">.</span>y <span class="token operator">?</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> pc<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pd<span class="token punctuation">.</span>y <span class="token operator">-</span> pc<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>

    var sx <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>pa<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pb<span class="token punctuation">.</span>x<span class="token punctuation">,</span> gradient1<span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    var ex <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pd<span class="token punctuation">.</span>x<span class="token punctuation">,</span> gradient2<span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 计算 开始Z值 和 结束Z值</span>
    var z1<span class="token punctuation">:</span> number <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>pa<span class="token punctuation">.</span>z<span class="token punctuation">,</span> pb<span class="token punctuation">.</span>z<span class="token punctuation">,</span> gradient1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    var z2<span class="token punctuation">:</span> number <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>z<span class="token punctuation">,</span> pd<span class="token punctuation">.</span>z<span class="token punctuation">,</span> gradient2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从左(sx)向右(ex)绘制一条线</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>var x <span class="token operator">=</span> sx<span class="token punctuation">;</span> x <span class="token operator">&lt;</span> ex<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var gradient<span class="token punctuation">:</span> number <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> sx<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>ex <span class="token operator">-</span> sx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 规范从左往右绘制</span>

        var z <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>z1<span class="token punctuation">,</span> z2<span class="token punctuation">,</span> gradient<span class="token punctuation">)</span><span class="token punctuation">;</span>

        this<span class="token punctuation">.</span><span class="token function">drawPoint</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BABYLON<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>【译者注：JavaScript代码】</p>
<pre><code class="ಠhighlight-container"><span class="token keyword">function</span> <span class="token function">Device</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    this<span class="token punctuation">.</span>workingCanvas <span class="token operator">=</span> canvas<span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>workingWidth <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>workingHeight <span class="token operator">=</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>workingContext <span class="token operator">=</span> this<span class="token punctuation">.</span>workingCanvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"2d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>depthbuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>this<span class="token punctuation">.</span>workingWidth <span class="token operator">*</span> this<span class="token punctuation">.</span>workingHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 用指定颜色清除后台缓冲区</span>
Device<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>clear <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用默认颜色清除后台缓冲区</span>
    this<span class="token punctuation">.</span>workingContext<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> this<span class="token punctuation">.</span>workingWidth<span class="token punctuation">,</span> this<span class="token punctuation">.</span>workingHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 缓存后台缓冲区</span>
    this<span class="token punctuation">.</span>backbuffer <span class="token operator">=</span> this<span class="token punctuation">.</span>workingContext<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> this<span class="token punctuation">.</span>workingWidth<span class="token punctuation">,</span> this<span class="token punctuation">.</span>workingHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 清除深度缓冲区</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>var i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> this<span class="token punctuation">.</span>depthbuffer<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用最大值填充</span>
        this<span class="token punctuation">.</span>depthbuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10000000</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 调用此方法把一个像素绘制到指定的X, Y坐标上 </span>
Device<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>putPixel <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    this<span class="token punctuation">.</span>backbufferdata <span class="token operator">=</span> this<span class="token punctuation">.</span>backbuffer<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token comment">// 我们的后台缓冲区是一维数组  </span>
    <span class="token comment">// 这里我们简单计算，将X和Y对应到此一维数组中  </span>
    var index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> this<span class="token punctuation">.</span>workingWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    var index4 <span class="token operator">=</span> index <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>this<span class="token punctuation">.</span>depthbuffer<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">&lt;</span> z<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 深度测试不通过</span>
    <span class="token punctuation">}</span>

    this<span class="token punctuation">.</span>depthbuffer<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> z<span class="token punctuation">;</span>

    <span class="token comment">// 在Html5 canvas中使用RGBA颜色空间  </span>
    this<span class="token punctuation">.</span>backbufferdata<span class="token punctuation">[</span>index4<span class="token punctuation">]</span> <span class="token operator">=</span> color<span class="token punctuation">.</span>r <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>backbufferdata<span class="token punctuation">[</span>index4 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> color<span class="token punctuation">.</span>g <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>backbufferdata<span class="token punctuation">[</span>index4 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> color<span class="token punctuation">.</span>b <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">;</span>
    this<span class="token punctuation">.</span>backbufferdata<span class="token punctuation">[</span>index4 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> color<span class="token punctuation">.</span>a <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 将三维坐标和变换矩阵转换成二维坐标 </span>
Device<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>project <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>coord<span class="token punctuation">,</span> transMat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 进行坐标变换  </span>
    var point <span class="token operator">=</span> BABYLON<span class="token punctuation">.</span>Vector3<span class="token punctuation">.</span><span class="token function">TransformCoordinates</span><span class="token punctuation">(</span>coord<span class="token punctuation">,</span> transMat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 变换后的坐标起始点是坐标系的中心点  </span>
    <span class="token comment">// 但是，在屏幕上，我们以左上角为起始点  </span>
    <span class="token comment">// 我们需要重新计算使他们的起始点变成左上角</span>
    var x <span class="token operator">=</span> point<span class="token punctuation">.</span>x <span class="token operator">*</span> this<span class="token punctuation">.</span>workingWidth <span class="token operator">+</span> this<span class="token punctuation">.</span>workingWidth <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    var y <span class="token operator">=</span> <span class="token operator">-</span>point<span class="token punctuation">.</span>y <span class="token operator">*</span> this<span class="token punctuation">.</span>workingHeight <span class="token operator">+</span> this<span class="token punctuation">.</span>workingHeight <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BABYLON<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> point<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 如果二维坐标在可视范围内则绘制  </span>
Device<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>drawPoint <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>point<span class="token punctuation">,</span> color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断是否在屏幕内  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span>x <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>y <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> this<span class="token punctuation">.</span>workingWidth <span class="token operator">&amp;&amp;</span> point<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> this<span class="token punctuation">.</span>workingHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 绘制一个点</span>
        this<span class="token punctuation">.</span><span class="token function">putPixel</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x<span class="token punctuation">,</span> point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> point<span class="token punctuation">.</span>z<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 在两点之间从左到右绘制一条线段</span>
<span class="token comment">// papb -&gt; pcpd</span>
<span class="token comment">// pa, pb, pc, pd在之前必须已经排好序</span>
Device<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>processScanLine <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>y<span class="token punctuation">,</span> pa<span class="token punctuation">,</span> pb<span class="token punctuation">,</span> pc<span class="token punctuation">,</span> pd<span class="token punctuation">,</span> color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 由当前的y值，我们可以计算出梯度</span>
    <span class="token comment">// 以此再计算出 起始X(sx) 和 结束X(ex)</span>
    <span class="token comment">// 如果pa.Y == pb.Y 或者 pc.Y== pd.y的话，梯度强制为1</span>
    var gradient1 <span class="token operator">=</span> pa<span class="token punctuation">.</span>y <span class="token operator">!=</span> pb<span class="token punctuation">.</span>y <span class="token operator">?</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> pa<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pb<span class="token punctuation">.</span>y <span class="token operator">-</span> pa<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    var gradient2 <span class="token operator">=</span> pc<span class="token punctuation">.</span>y <span class="token operator">!=</span> pd<span class="token punctuation">.</span>y <span class="token operator">?</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> pc<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pd<span class="token punctuation">.</span>y <span class="token operator">-</span> pc<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>

    var sx <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>pa<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pb<span class="token punctuation">.</span>x<span class="token punctuation">,</span> gradient1<span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    var ex <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pd<span class="token punctuation">.</span>x<span class="token punctuation">,</span> gradient2<span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 计算 开始Z值 和 结束Z值</span>
    var z1 <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>pa<span class="token punctuation">.</span>z<span class="token punctuation">,</span> pb<span class="token punctuation">.</span>z<span class="token punctuation">,</span> gradient1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    var z2 <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>z<span class="token punctuation">,</span> pd<span class="token punctuation">.</span>z<span class="token punctuation">,</span> gradient2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从左(sx)向右(ex)绘制一条线</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>var x <span class="token operator">=</span> sx<span class="token punctuation">;</span> x <span class="token operator">&lt;</span> ex<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var gradient <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> sx<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>ex <span class="token operator">-</span> sx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        var z <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>z1<span class="token punctuation">,</span> z2<span class="token punctuation">,</span> gradient<span class="token punctuation">)</span><span class="token punctuation">;</span>
        this<span class="token punctuation">.</span><span class="token function">drawPoint</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BABYLON<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>使用这些新代码，你将获得的效果：</p>
<p><a href="http://david.blob.core.windows.net/softengine3d/part4/index.html" target="_blank">运行代码</a></p>
<p>同样的，你可以下载源代码：</p>
<p>C#：<a href="http://david.blob.core.windows.net/softengine3d/SoftEngineCSharpPart4.zip" target="_blank">SoftEngineCSharpPart4.zip</a></p>
<p>TypeScript：<a href="http://david.blob.core.windows.net/softengine3d/SoftEngineTSPart4.zip" target="_blank">SoftEngineTSPart4.zip</a></p>
<p>JavaScript：<a href="http://david.blob.core.windows.net/softengine3d/SoftEngineJSPart4.zip" target="_blank">SoftEngineJSPart4.zip</a>&nbsp;或只需右键点击 -&gt; 查看框架的源代码</p>
<p>在下一章节，第五个教程中，我们将看到如何模拟光照着色效果，我们将得到这样的画面：</p>
<p><img src="./光栅化三角形_files/2016-03-22_56f0e989db68b.jpg" alt="高氏着色" title="高氏着色"></p>
</div><div class="article-navigation"><span class="prev">上一篇：<a href="https://www.kancloud.cn/digest/soft-3d-engine/130055">三，加载通过Blender扩展导出JSON格式的网格</a></span><span class="next">下一篇：<a href="https://www.kancloud.cn/digest/soft-3d-engine/130057">五，额外章节，使用技巧和并行处理来提高性能</a></span></div><div class="article-foot"></div></div></div></div></div></div>
<script type="application/payload+json">
    {
        "config":{"plugins":["highlight"],"title":"3D\u8f6f\u4ef6\u6e32\u67d3\u5668\u5165\u95e8","description":"\u672c\u7cfb\u5217\u4e2d\u6211\u4eec\u5c06\u4f7f\u7528C#\u3001JavaScript\u3001TypeScript\u4e09\u79cd\u8bed\u8a00\u8fdb\u884c\u7f16\u5199\uff0c\u5e76\u914d\u5408Html5\u505a\u5728\u7ebf\u6f14\u793a\u3002\u4e3a\u4e86\u66f4\u597d\u7684\u4e86\u89e3\u73b0\u4ee33D\u56fe\u5f62\u5b66\u57fa\u7840\uff0c\u6211\u4eec\u4f7f\u7528CPU\u6765\u5b8c\u62103D\u6e32\u67d3\uff0c\u8ba9\u4f60\u5bf9\u56fe\u5f62\u7684\u8ba4\u8bc6\u66f4\u52a0\u6df1\u523b\u3002\n        ","cover":"https:\/\/box.kancloud.cn\/cover_2016-03-22_56f0f51db025_800x1068.jpg-bookmiddle","author":{"name":"\u6d41\u5e74","email":"thinkphp@qq.com","url":"https:\/\/www.kancloud.cn\/@thinkphp"}},
        "options":{"book":{"id":8533,"title":"3D\u8f6f\u4ef6\u6e32\u67d3\u5668\u5165\u95e8","namespace":"digest","name":"soft-3d-engine","price":0,"cover":"https:\/\/box.kancloud.cn\/cover_2016-03-22_56f0f51db025_800x1068.jpg","middle_cover":"https:\/\/box.kancloud.cn\/cover_2016-03-22_56f0f51db025_800x1068.jpg-bookmiddle","small_cover":"https:\/\/box.kancloud.cn\/cover_2016-03-22_56f0f51db025_800x1068.jpg-booksmall"},"plugins":{"host":"plugins.kancloud.cn","scheme":"https"},"web":{"host":"www.kancloud.cn","scheme":"https"},"environment":"reader","base":"\/digest\/soft-3d-engine\/content","entry":"\/digest\/soft-3d-engine"},
        "style": "",
        "article":{"path":"130056","ref":"50010073.md","title":"\u56db\uff0c\u586b\u5145\u5149\u6805\u5316\u7684\u4e09\u89d2\u5f62\u5e76\u4f7f\u7528\u6df1\u5ea6\u7f13\u51b2","content":"\u8bd1\u8005\u524d\u8a00\uff1a\n\n\u672c\u6587\u8bd1\u81ea[MSDN](http:\/\/blogs.msdn.com\/b\/davrous\/archive\/2013\/06\/13\/tutorial-series-learning-how-to-write-a-3d-soft-engine-from-scratch-in-c-typescript-or-javascript.aspx)\uff0c\u539f\u4f5c\u8005\u4e3a[David Rousset](https:\/\/social.msdn.microsoft.com\/profile\/david%20rousset\/)\uff0c\u6587\u7ae0\u4e2d\u5982\u679c\u6709\u6211\u7684\u989d\u5916\u8bf4\u660e\uff0c\u6211\u4f1a\u52a0\u4e0a\u3010\u8bd1\u8005\u6ce8\uff1a\u3011\u3002\n\n  \n\n\u6b63\u6587\u5f00\u59cb\uff1a\n\n\u5728\u524d\u9762\u7684\u6559\u7a0b\u4e2d\uff0c\u6211\u4eec\u5b66\u4e60\u4e86\u5982\u4f55\u5728C#\u3001TypeScript\u6216JavaScript\u4e2d\u7f16\u51993D\u8f6f\u4ef6\u6e32\u67d3\u5f15\u64ce\u4e2d\u7684\u4eceBlender\u52a0\u8f7d\u5bfc\u51fa\u7f51\u683c\u8fd9\u4e00\u7ae0\u8282\u3002\n\n\u6211\u4eec\u5df2\u7ecf\u80fd\u591f\u5728\u5f15\u64ce\u4e2d\u52a0\u8f7d\u4eceBlender\u5bfc\u51fa\u7684Json\u6587\u4ef6\u4e86\u3002\u90a3\u4e48\u5230\u73b0\u5728\u4e3a\u6b62\uff0c\u6211\u4eec\u7684\u6e32\u67d3\u6548\u679c\u4f9d\u7136\u53ea\u662f\u7b80\u5355\u7684\u7ebf\u6846\u6e32\u67d3\u3002\u4f46\u662f\uff0c\u5728\u672c\u7ae0\u6211\u4eec\u5c06\u8bb2\u89e3\u5982\u4f55\u4f7f\u7528\u4e09\u89d2\u5f62\u5149\u6805\u5316\u7b97\u6cd5\u6765\u586b\u5145\u4e09\u89d2\u5f62\u3002\u7136\u540e\uff0c\u6211\u4eec\u5c06\u4f7f\u7528\u6df1\u5ea6\u7f13\u51b2\uff0c\u4ee5\u907f\u514d\u5728\u540e\u9762\u7684\u9762\u8dd1\u5230\u524d\u9762\u6765\u7684\u95ee\u9898\u3002\n\n  \n\n\u672c\u7ae0\u6559\u7a0b\u662f\u4ee5\u4e0b\u7cfb\u5217\u7684\u4e00\u90e8\u5206\uff1a  \n\n[1 \u2013 \u7f16\u5199\u76f8\u673a\u3001\u7f51\u683c\u548c\u8bbe\u5907\u5bf9\u8c61\u7684\u6838\u5fc3\u903b\u8f91](http:\/\/blog.csdn.net\/teajs\/article\/details\/49989681)\n\n[2 \u2013 \u7ed8\u5236\u7ebf\u6bb5\u548c\u4e09\u89d2\u5f62\u6765\u83b7\u5f97\u7ebf\u6846\u6e32\u67d3\u6548\u679c](http:\/\/blog.csdn.net\/teajs\/article\/details\/49998675)\n\n[3 \u2013 \u52a0\u8f7d\u901a\u8fc7Blender\u6269\u5c55\u5bfc\u51faJSON\u683c\u5f0f\u7684\u7f51\u683c](http:\/\/blog.csdn.net\/teajs\/article\/details\/50001659)\n\n4 \u2013\u586b\u5145\u5149\u6805\u5316\u7684\u4e09\u89d2\u5f62\u5e76\u4f7f\u7528\u6df1\u5ea6\u7f13\u51b2\uff08\u672c\u6587\uff09\n\n[4b \u2013 \u989d\u5916\u7ae0\u8282\uff1a\u4f7f\u7528\u6280\u5de7\u548c\u5e76\u884c\u5904\u7406\u6765\u63d0\u9ad8\u6027\u80fd](http:\/\/blog.csdn.net\/teajs\/article\/details\/50054509)\n\n[5 \u2013 \u4f7f\u7528\u5e73\u9762\u7740\u8272\u548c\u9ad8\u6c0f\u7740\u8272\u5904\u7406\u5149 \u00a0](http:\/\/blogs.msdn.com\/b\/davrous\/archive\/2013\/07\/03\/tutorial-part-5-learning-how-to-write-a-3d-software-engine-in-c-ts-or-js-flat-amp-gouraud-shading.aspx)\n\n[6 \u2013 \u5e94\u7528\u7eb9\u7406\u3001\u80cc\u9762\u5254\u9664\u4ee5\u53ca\u4e00\u4e9bWebGL\u76f8\u5173](http:\/\/blogs.msdn.com\/b\/davrous\/archive\/2013\/07\/18\/tutorial-part-6-learning-how-to-write-a-3d-software-engine-in-c-ts-or-js-texture-mapping-back-face-culling-amp-webgl.aspx)\n\n  \n\n\u901a\u8fc7\u672c\u7ae0\u8282\uff0c\u4f60\u5c06\u80fd\u591f\u770b\u5230\u8fd9\u6837\u7684\u6548\u679c\uff1a  \n\n[\u70b9\u51fb\u8fd0\u884c](http:\/\/david.blob.core.windows.net\/softengine3d\/part4\/index.html)\n\n  \n\n**\u5149\u6805\u5316**\n\n\u3010\u8bd1\u8005\u6ce8\uff1a\u611f\u8c22\u56db\u5ddd-\u5e73\u751f\u5c0f\u54e5\u4e3a\u6211\u4eec\u7ffb\u8bd1\u6b64\u6bb5\u3011\n\n\u6709\u5f88\u591a\u4e0d\u540c\u7c7b\u578b\u7684\u5149\u6805\u5316\u7b97\u6cd5\u3002\u6211\u751a\u81f3\u77e5\u9053\u5728\u6211\u7684\u56e2\u961f\u4e2d\u6709\u4eba\u5411\u77e5\u540d\u7684GPU\u5382\u5546\u63d0\u51fa\u4e86\u81ea\u5df1\u7684\u5149\u6805\u5316\u7b97\u6cd5\u3002\u4e5f\u591a\u4e8f\u4e86\u4ed6\uff0c\u6211\u73b0\u5728\u77e5\u9053\u4e86\u4ec0\u4e48\u662f[\u6298\u884c\u4e66](https:\/\/en.wikipedia.org\/wiki\/Boustrophedon)\u5e76\u4e00\u76f4\u4f7f\u7528\u81f3\u4eca\u3002 :-)\n\n  \n\n\u4e3a\u4e86\u66f4\u6b63\u89c4\uff0c\u6211\u4eec\u5c06\u5728\u672c\u6559\u7a0b\u4e2d\u5b9e\u73b0\u4e00\u4e2a\u7b80\u5355\u800c\u6709\u6548\u7684\u5149\u6805\u5316\u7b97\u6cd5\u3002\u6b63\u5982\u6211\u4eec\u5728CPU\u4e2d\u8fd0\u884c3D\u8f6f\u4ef6\u6e32\u67d3\u5f15\u64ce\u4e00\u822c\uff0c\u5b83\u4f1a\u8017\u8d39\u6211\u4eec\u7684\u5927\u91cfCPU\u8fd0\u7b97\u3002\u5f53\u7136\uff0c\u73b0\u4eca\u8fd9\u4e2a\u529f\u80fd\u5df2\u7ecf\u76f4\u63a5\u7528GPU\u6765\u5e2e\u6211\u4eec\u5b8c\u6210\u3002\n\n\u5148\u8ba9\u6211\u4eec\u505a\u4e00\u4e2a\u7ec3\u4e60\u3002\u8bf7\u62ff\u51fa\u4e00\u5f20\u7eb8\uff0c\u7136\u540e\u753b\u4e00\u4e2a\u4e09\u89d2\u5f62\uff0c\u55ef\u2026\u2026\u4efb\u610f\u4f60\u6240\u80fd\u753b\u51fa\u6765\u7684\u4e09\u89d2\u5f62\u3002\u6211\u4eec\u8981\u627e\u51fa\u4e00\u4e2a\u901a\u7528\u7684\u65b9\u6cd5\u53ef\u4ee5\u5f97\u51fa\u4efb\u610f\u7c7b\u578b\u7684\u4e09\u89d2\u5f62\u3002\n\n  \n\n\u5982\u679c\u6211\u4eec\u6309Y\u8f74\u5bf9\u6bcf\u4e2a\u4e09\u89d2\u5f62\u7684\u4e09\u4e2a\u70b9\u8fdb\u884c\u6392\u5e8f\uff0c\u4fdd\u8bc1 P1 \u540e\u9762\u662f P2\uff0c \u7136\u540e\u662f P3 \u7684\u8bdd\uff0c\u6700\u7ec8\u5c06\u51fa\u73b0\u4e24\u79cd\u53ef\u80fd\u7684\u60c5\u51b5\uff1a\n\n![\u4e09\u89d2\u5f62\u7684\u4e24\u79cd\u60c5\u51b5](https:\/\/box.kancloud.cn\/2016-03-22_56f0e989ca528.jpg \"\u4e09\u89d2\u5f62\u7684\u4e24\u79cd\u60c5\u51b5\")\n  \n\n\u4f60\u5c06\u4f1a\u770b\u5230\u8fd9\u4e24\u79cd\u60c5\u51b5\uff1a\n\nP2 \u5728 P1 \u548c P3 \u7684\u53f3\u4fa7 \u6216 P2\u5728 P1 \u548c P3 \u7684\u5de6\u4fa7\u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u7531\u4e8e\u6211\u4eec\u59cb\u7ec8\u662f\u4ece\u5de6\u5230\u53f3(sx \u5230 se)\u7684\u987a\u5e8f\u753b\u7ebf\uff0c\u6240\u4ee5\u5c31\u6309\u7167\u8fd9\u4e2a\u5047\u8bbe\u6765\u5904\u7406\u8fd9\u4e24\u79cd\u60c5\u51b5\u3002\n\n  \n\n\u6b64\u5916\uff0c\u6211\u4eec\u8981\u987a\u7740\u5de6\u56fe\u4e2d\u7684\u7ea2\u7ebf\u81ea\u4e0a\u800c\u4e0b (\u4ece P1.Y \u5230 \u00a0P3.Y) \u4ece\u5de6\u5411\u53f3\u7ed8\u5236\u3002\u4f46\u662f\u5f53\u5230\u8fbeP2.Y\u65f6\u6211\u4eec\u9700\u8981\u7a0d\u5fae\u6539\u53d8\u4e00\u4e0b\u903b\u8f91\uff0c\u56e0\u4e3a\u8fd9\u65f6\u4e24\u79cd\u60c5\u51b5\u7684\u659c\u7387\u90fd\u4f1a\u53d1\u751f\u6539\u53d8\u3002\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48\u6211\u4eec\u5c06\u626b\u63cf\u7ebf\u5904\u7406\u5206\u4e3a\u4e24\u4e2a\u6b65\u9aa4\uff1a\u4ece P1.Y \u5411\u4e0b\u79fb\u52a8\u5230 P2.Y\uff0c\u7136\u540e\u4eceP2.Y \u6700\u7ec8\u79fb\u52a8\u5230 P3.Y\u3002\n\n  \n\n\u8981\u4e86\u89e3\u6211\u4eec\u4f7f\u7528\u7b97\u6cd5\u7684\u5168\u90e8\u903b\u8f91\uff0c\u53ef\u4ee5\u5728\u7ef4\u57fa\u767e\u79d1\u4e2d\u627e\u5230\u8bcd\u6761\uff1a[http:\/\/en.wikipedia.org\/wiki\/Slope](http:\/\/en.wikipedia.org\/wiki\/Slope \"http:\/\/en.wikipedia.org\/wiki\/Slope\")\u3002\u5b83\u53ea\u662f\u4e00\u4e9b\u57fa\u672c\u7684\u6570\u5b66\u8fd0\u7b97\u3002\n\n  \n\n\u4e3a\u4e86\u80fd\u591f\u9002\u5e94\u8fd9\u4e24\u79cd\u60c5\u51b5\uff0c\u4f60\u53ea\u9700\u8981\u8fdb\u884c\u7b80\u5355\u7684\u8fd0\u7b97\uff1a\n\ndP1P2 = P2.X - P1.X \/ P2.Y - P1.Y\n\ndP1P3 = P3.X - P1.X \/ P3.Y - P1.Y\n\n  \n\n\u90a3\u6211\u4eec\u5982\u4f55\u5f97\u77e5\u662f\u5c5e\u4e8e\u54ea\u79cd\u60c5\u51b5\u5462\uff1f\n\nP2 \u5728\u53f3\u7684\u7b2c\u4e00\u79cd\u60c5\u51b5\uff1adP1P2 > dP1P3\n\nP2 \u5728\u5de6\u7684\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff1adP1P3 > dP1P2\u00a0\n\n  \n\n\u73b0\u5728\u5df2\u7ecf\u6709\u4e86\u7b97\u6cd5\u7684\u57fa\u672c\u903b\u8f91\uff0c\u6211\u4eec\u9700\u8981\u77e5\u9053\u5982\u4f55\u8ba1\u7b97\u4e0a\u56fe\u4e2d\u6bcf\u6761\u7ebf\u4e0a\u7684 sx(\u8d77\u59cb\u7684 x \u5750\u6807) \u548c ex(\u7ed3\u675f\u7684 x \u5750\u6807) \u4e4b\u95f4\u7684 x\u3002\u56e0\u6b64\u8981\u9996\u5148\u8ba1\u7b97\u51fa sx \u548c ex\u3002\u7531\u4e8e\u6211\u4eec\u77e5\u9053\u5f53\u524d\u6240\u626b\u63cf\u5230\u7684 y \u503c\u3001P1P3 \u548c P1P3 \u7684\u659c\u7387\uff0c\u56e0\u6b64\u6211\u4eec\u4e0d\u96be\u5f97\u51fa sx \u548c ex \u503c\u3002\n\n  \n\n\u4ee5\u60c5\u51b51\u4e3a\u4f8b\u3002\u9996\u5148\u5229\u7528\u5f53\u524d\u7684 y \u503c\u6765\u8ba1\u7b97\u68af\u5ea6\u3002\u5b83\u5c06\u544a\u8bc9\u6211\u4eec\u5728 P1.Y \u548c P2.Y\u4e4b\u95f4\u8fdb\u884c\u5904\u7406\u65f6\uff0c\u6211\u4eec\u5f53\u524d\u6240\u5904\u7684\u9636\u6bb5\u3002\n\n  \n\n\u68af\u5ea6 = \u5f53\u524d\u7684y\u503c - P1.Y \/ P2.Y - P1.Y\n\n  \n\n\u56e0\u4e3a x \u548c y \u662f\u7ebf\u6027\u8fde\u63a5\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u57fa\u4e8e\u8be5\u68af\u5ea6\uff0c\u5229\u7528 P1.X \u548c P3.X \u6765\u8ba1\u7b97 sx \u63d2\u503c\uff0c\u5e76\u5229\u7528 P1.X \u548c P2.X\u6765\u8ba1\u7b97 ex \u63d2\u503c\u3002\n\n  \n\n\u5982\u679c\u60a8\u80fd\u591f\u7406\u89e3\u63d2\u503c\u8fd9\u4e2a\u6982\u5ff5\uff0c\u90a3\u4e48\u4f60\u5c31\u80fd\u591f\u7406\u89e3\u5269\u4e0b\u6240\u6709\u5173\u4e8e\u5149\u7ea4\u548c\u6750\u8d28\u3002\u800c\u4e14\u4f60\u80fd\u591f\u5f88\u597d\u7684\u9605\u8bfb\u76f8\u5173\u4ee3\u7801\uff0c\u4e5f\u80fd\u591f\u4ece\u5934\u5f00\u59cb\u81ea\u5df1\u91cd\u5199\u4ee3\u7801\uff0c\u800c\u65e0\u987b\u590d\u5236\u3001\u7c98\u8d34\u4e0b\u9762\u7684\u4ee3\u7801\u3002\n\n  \n\n\u5982\u679c\u8fd8\u4e0d\u662f\u5f88\u6e05\u695a\u7684\u8bdd\uff0c\u8fd9\u91cc\u6709\u4e00\u4e9b\u5173\u4e8e\u5149\u6805\u5316\u7684\u6587\u7ae0\u4ee5\u4f9b\u9605\u8bfb\uff1a\n\n[- 3D\u8f6f\u4ef6\u6e32\u67d3\u5f15\u64ce - \u7b2c\u4e00\u90e8\u5206](http:\/\/www.codeproject.com\/Articles\/170296\/3D-Software-Rendering-Engine-Part-I)\n\n[- \u4e09\u89d2\u5f62\u5149\u6805\u5316](https:\/\/lva.cg.tuwien.ac.at\/ecg\/wiki\/doku.php?id=students:fill_rasterization)\n\n[- \u586b\u5145\u4e09\u89d2\u5f62\u7684\u8f6f\u4ef6\u5149\u6805\u5316\u7b97\u6cd5](http:\/\/www.sunshine2k.de\/coding\/java\/TriangleRasterization\/TriangleRasterization.html)\n\n  \n\n\u73b0\u5728\uff0c\u57fa\u4e8e\u6211\u4eec\u73b0\u6709\u7684\u7b97\u6cd5\u63cf\u8ff0\u8bf4\u660e\u8ba9\u6211\u4eec\u5f00\u59cb\u7f16\u5199\u4ee3\u7801\u3002\u9996\u5148\uff0c\u4ece\u8bbe\u5907\u5bf9\u8c61\u5220\u9664 drawLine \u548c drawBline \u51fd\u6570\uff0c\u5e76\u7528\u4e0b\u9762\u7684\u4ee3\u7801\u8fdb\u884c\u66ff\u6362\uff1a\n\n\u3010\u8bd1\u8005\u6ce8\uff1aC#\u4ee3\u7801\u3011\n\n~~~\n\/\/ \u5c06\u4e09\u7ef4\u5750\u6807\u548c\u53d8\u6362\u77e9\u9635\u8f6c\u6362\u6210\u4e8c\u7ef4\u5750\u6807  \npublic Vector3 Project(Vector3 coord, Matrix transMat)\n{\n    \/\/ \u8fdb\u884c\u5750\u6807\u53d8\u6362  \n    var point = Vector3.TransformCoordinate(coord, transMat);\n    \/\/ \u53d8\u6362\u540e\u7684\u5750\u6807\u8d77\u59cb\u70b9\u662f\u5750\u6807\u7cfb\u7684\u4e2d\u5fc3\u70b9  \n    \/\/ \u4f46\u662f\uff0c\u5728\u5c4f\u5e55\u4e0a\uff0c\u6211\u4eec\u4ee5\u5de6\u4e0a\u89d2\u4e3a\u8d77\u59cb\u70b9  \n    \/\/ \u6211\u4eec\u9700\u8981\u91cd\u65b0\u8ba1\u7b97\u4f7f\u4ed6\u4eec\u7684\u8d77\u59cb\u70b9\u53d8\u6210\u5de6\u4e0a\u89d2\n    var x = point.X * bmp.PixelWidth + bmp.PixelWidth \/ 2.0f;\n    var y = -point.Y * bmp.PixelHeight + bmp.PixelHeight \/ 2.0f;\n    return (new Vector3(x, y, point.Z));\n}\n\n\/\/ \u5982\u679c\u4e8c\u7ef4\u5750\u6807\u5728\u53ef\u89c6\u8303\u56f4\u5185\u5219\u7ed8\u5236\npublic void DrawPoint(Vector2 point, Color4 color)\n{\n    \/\/ \u5224\u65ad\u662f\u5426\u5728\u5c4f\u5e55\u5185  \n    if (point.X >= 0 && point.Y >= 0 && point.X < bmp.PixelWidth && point.Y < bmp.PixelHeight)\n    {\n        \/\/ \u7ed8\u5236\u4e00\u4e2a\u70b9\n        PutPixel((int)point.X, (int)point.Y, color);\n    }\n}\n~~~\n  \n\u3010\u8bd1\u8005\u6ce8\uff1aTypeScript\u4ee3\u7801\u3011\n\n~~~\n\/\/ \u5c06\u4e09\u7ef4\u5750\u6807\u548c\u53d8\u6362\u77e9\u9635\u8f6c\u6362\u6210\u4e8c\u7ef4\u5750\u6807\npublic project(coord: BABYLON.Vector3, transMat: BABYLON.Matrix): BABYLON.Vector3 {\n    \/\/ \u8fdb\u884c\u5750\u6807\u53d8\u6362  \n    var point = BABYLON.Vector3.TransformCoordinates(coord, transMat);\n    \/\/ \u53d8\u6362\u540e\u7684\u5750\u6807\u8d77\u59cb\u70b9\u662f\u5750\u6807\u7cfb\u7684\u4e2d\u5fc3\u70b9  \n    \/\/ \u4f46\u662f\uff0c\u5728\u5c4f\u5e55\u4e0a\uff0c\u6211\u4eec\u4ee5\u5de6\u4e0a\u89d2\u4e3a\u8d77\u59cb\u70b9  \n    \/\/ \u6211\u4eec\u9700\u8981\u91cd\u65b0\u8ba1\u7b97\u4f7f\u4ed6\u4eec\u7684\u8d77\u59cb\u70b9\u53d8\u6210\u5de6\u4e0a\u89d2\n    var x = point.x * this.workingWidth + this.workingWidth \/ 2.0;\n    var y = -point.y * this.workingHeight + this.workingHeight \/ 2.0;\n    return (new BABYLON.Vector3(x, y, point.z));\n}\n\n\/\/ \u5982\u679c\u4e8c\u7ef4\u5750\u6807\u5728\u53ef\u89c6\u8303\u56f4\u5185\u5219\u7ed8\u5236\npublic drawPoint(point: BABYLON.Vector2, color: BABYLON.Color4): void {\n    \/\/ \u5224\u65ad\u662f\u5426\u5728\u5c4f\u5e55\u5185\n    if(point.x >= 0 && point.y >= 0 && point.x < this.workingWidth && point.y < this.workingHeight) {\n        \/\/ \u7ed8\u5236\u4e00\u4e2a\u70b9\n        this.putPixel(point.x, point.y, color);\n    }\n}\n~~~\n  \n\u3010\u8bd1\u8005\u6ce8\uff1aJavaScript\u4ee3\u7801\u3011\n\n~~~\n\/\/ \u5c06\u4e09\u7ef4\u5750\u6807\u548c\u53d8\u6362\u77e9\u9635\u8f6c\u6362\u6210\u4e8c\u7ef4\u5750\u6807\nDevice.prototype.project = function (coord, transMat) {\n    var point = BABYLON.Vector3.TransformCoordinates(coord, transMat);\n    \/\/ \u53d8\u6362\u540e\u7684\u5750\u6807\u8d77\u59cb\u70b9\u662f\u5750\u6807\u7cfb\u7684\u4e2d\u5fc3\u70b9  \n    \/\/ \u4f46\u662f\uff0c\u5728\u5c4f\u5e55\u4e0a\uff0c\u6211\u4eec\u4ee5\u5de6\u4e0a\u89d2\u4e3a\u8d77\u59cb\u70b9  \n    \/\/ \u6211\u4eec\u9700\u8981\u91cd\u65b0\u8ba1\u7b97\u4f7f\u4ed6\u4eec\u7684\u8d77\u59cb\u70b9\u53d8\u6210\u5de6\u4e0a\u89d2\n    var x = point.x * this.workingWidth + this.workingWidth \/ 2.0 >> 0;\n    var y = -point.y * this.workingHeight + this.workingHeight \/ 2.0 >> 0;\n    return (new BABYLON.Vector3(x, y, point.z));\n};\n\n\/\/ \u5982\u679c\u4e8c\u7ef4\u5750\u6807\u5728\u53ef\u89c6\u8303\u56f4\u5185\u5219\u7ed8\u5236\nDevice.prototype.drawPoint = function (point, color) {\n    \/\/ \u5224\u65ad\u662f\u5426\u5728\u5c4f\u5e55\u5185\n    if (point.x >= 0 && point.y >= 0 && point.x < this.workingWidth\n                                        && point.y < this.workingHeight) {\n        \/\/ \u7ed8\u5236\u4e00\u4e2a\u70b9\n        this.putPixel(point.x, point.y, color);\n    }\n};\n~~~\n  \n\u6211\u4eec\u4ec5\u4ec5\u505a\u4e86\u4e00\u4e9b\u51c6\u5907\uff0c\u4e0b\u9762\u5219\u662f\u6700\u91cd\u8981\u7684\u90e8\u5206\uff0c\u57fa\u4e8e\u5148\u524d\u89e3\u91ca\u8fc7\u7684\u4e09\u89d2\u5f62\u7684\u903b\u8f91\u8fdb\u884c\u7ed8\u5236\u3002\n\n\u3010\u8bd1\u8005\u6ce8\uff1aC#\u4ee3\u7801\u3011\n\n~~~\n\/\/ \u9650\u5236\u6570\u503c\u8303\u56f4\u57280\u548c1\u4e4b\u95f4\nfloat Clamp(float value, float min = 0, float max = 1)\n{\n    return Math.Max(min, Math.Min(value, max));\n}\n\n\/\/ \u8fc7\u6e21\u63d2\u503c\nfloat Interpolate(float min, float max, float gradient)\n{\n    return min + (max - min) * Clamp(gradient);\n}\n\n\/\/ \u5728\u4e24\u70b9\u4e4b\u95f4\u4ece\u5de6\u5230\u53f3\u7ed8\u5236\u4e00\u6761\u7ebf\u6bb5\n\/\/ papb -> pcpd\n\/\/ pa, pb, pc, pd\u5728\u4e4b\u524d\u5fc5\u987b\u5df2\u7ecf\u6392\u597d\u5e8f\nvoid ProcessScanLine(int y, Vector3 pa, Vector3 pb, Vector3 pc, Vector3 pd, Color4 color)\n{\n    \/\/ \u7531\u5f53\u524d\u7684y\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba1\u7b97\u51fa\u68af\u5ea6\n    \/\/ \u4ee5\u6b64\u518d\u8ba1\u7b97\u51fa \u8d77\u59cbX(sx) \u548c \u7ed3\u675fX(ex)\n    \/\/ \u5982\u679cpa.Y == pb.Y \u6216\u8005 pc.Y== pd.y\u7684\u8bdd\uff0c\u68af\u5ea6\u5f3a\u5236\u4e3a1\n    var gradient1 = pa.Y != pb.Y ? (y - pa.Y) \/ (pb.Y - pa.Y) : 1;\n    var gradient2 = pc.Y != pd.Y ? (y - pc.Y) \/ (pd.Y - pc.Y) : 1;\n\n    int sx = (int)Interpolate(pa.X, pb.X, gradient1);\n    int ex = (int)Interpolate(pc.X, pd.X, gradient2);\n\n    \/\/ \u4ece\u5de6(sx)\u5411\u53f3(ex)\u7ed8\u5236\u4e00\u6761\u7ebf\n    for (var x = sx; x < ex; x++)\n    {\n        DrawPoint(new Vector2(x, y), color);\n    }\n}\n\npublic void DrawTriangle(Vector3 p1, Vector3 p2, Vector3 p3, Color4 color)\n{\n    \/\/ \u8fdb\u884c\u6392\u5e8f\uff0cp1\u603b\u5728\u6700\u4e0a\u9762\uff0cp2\u603b\u5728\u6700\u4e2d\u95f4\uff0cp3\u603b\u5728\u6700\u4e0b\u9762\n    if (p1.Y > p2.Y)\n    {\n        var temp = p2;\n        p2 = p1;\n        p1 = temp;\n    }\n\n    if (p2.Y > p3.Y)\n    {\n        var temp = p2;\n        p2 = p3;\n        p3 = temp;\n    }\n\n    if (p1.Y > p2.Y)\n    {\n        var temp = p2;\n        p2 = p1;\n        p1 = temp;\n    }\n\n    \/\/ \u53cd\u5411\u659c\u7387\n    float dP1P2, dP1P3;\n\n    \/\/ http:\/\/en.wikipedia.org\/wiki\/Slope\n    \/\/ \u8ba1\u7b97\u53cd\u5411\u659c\u7387\n    if (p2.Y - p1.Y > 0)\n        dP1P2 = (p2.X - p1.X) \/ (p2.Y - p1.Y);\n    else\n        dP1P2 = 0;\n\n    if (p3.Y - p1.Y > 0)\n        dP1P3 = (p3.X - p1.X) \/ (p3.Y - p1.Y);\n    else\n        dP1P3 = 0;\n\n    \/\/ \u5bf9\u4e8e\u7b2c\u4e00\u79cd\u60c5\u51b5\u6765\u8bf4\uff0c\u4e09\u89d2\u5f62\u662f\u8fd9\u6837\u7684\uff1a\n    \/\/ P1\n    \/\/ -\n    \/\/ -- \n    \/\/ - -\n    \/\/ -  -\n    \/\/ -   - P2\n    \/\/ -  -\n    \/\/ - -\n    \/\/ -\n    \/\/ P3\n    if (dP1P2 > dP1P3)\n    {\n        for (var y = (int)p1.Y; y <= (int)p3.Y; y++)\n        {\n            if (y < p2.Y)\n            {\n                ProcessScanLine(y, p1, p3, p1, p2, color);\n            }\n            else\n            {\n                ProcessScanLine(y, p1, p3, p2, p3, color);\n            }\n        }\n    }\n    \/\/ \u5bf9\u4e8e\u7b2c\u4e8c\u79cd\u60c5\u51b5\u6765\u8bf4\uff0c\u4e09\u89d2\u5f62\u662f\u8fd9\u6837\u7684\uff1a\n    \/\/       P1\n    \/\/        -\n    \/\/       -- \n    \/\/      - -\n    \/\/     -  -\n    \/\/ P2 -   - \n    \/\/     -  -\n    \/\/      - -\n    \/\/        -\n    \/\/       P3\n    else\n    {\n        for (var y = (int)p1.Y; y <= (int)p3.Y; y++)\n        {\n            if (y < p2.Y)\n            {\n                ProcessScanLine(y, p1, p2, p1, p3, color);\n            }\n            else\n            {\n                ProcessScanLine(y, p2, p3, p1, p3, color);\n            }\n        }\n    }\n}\n~~~\n  \n\u3010\u8bd1\u8005\u6ce8\uff1aTypeScript\u4ee3\u7801\u3011\n\n~~~\n\/\/ \u9650\u5236\u6570\u503c\u8303\u56f4\u57280\u548c1\u4e4b\u95f4\npublic clamp(value: number, min: number = 0, max: number = 1): number {\n    return Math.max(min, Math.min(value, max));\n}\n\n\/\/ \u8fc7\u6e21\u63d2\u503c\npublic interpolate(min: number, max: number, gradient: number) {\n    return min + (max - min) * this.clamp(gradient);\n}\n\n\/\/ \u5728\u4e24\u70b9\u4e4b\u95f4\u4ece\u5de6\u5230\u53f3\u7ed8\u5236\u4e00\u6761\u7ebf\u6bb5\n\/\/ papb -> pcpd\n\/\/ pa, pb, pc, pd\u5728\u4e4b\u524d\u5fc5\u987b\u5df2\u7ecf\u6392\u597d\u5e8f\npublic processScanLine(y: number, pa: BABYLON.Vector3, pb: BABYLON.Vector3, \n                       pc: BABYLON.Vector3, pd: BABYLON.Vector3, color: BABYLON.Color4): void {\n    \/\/ \u7531\u5f53\u524d\u7684y\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba1\u7b97\u51fa\u68af\u5ea6\n    \/\/ \u4ee5\u6b64\u518d\u8ba1\u7b97\u51fa \u8d77\u59cbX(sx) \u548c \u7ed3\u675fX(ex)\n    \/\/ \u5982\u679cpa.Y == pb.Y \u6216\u8005 pc.Y== pd.y\u7684\u8bdd\uff0c\u68af\u5ea6\u5f3a\u5236\u4e3a1\n    var gradient1 = pa.y != pb.y ? (y - pa.y) \/ (pb.y - pa.y) : 1;\n    var gradient2 = pc.y != pd.y ? (y - pc.y) \/ (pd.y - pc.y) : 1;\n\n    var sx = this.interpolate(pa.x, pb.x, gradient1) >> 0;\n    var ex = this.interpolate(pc.x, pd.x, gradient2) >> 0;\n\n    \/\/ \u4ece\u5de6(sx)\u5411\u53f3(ex)\u7ed8\u5236\u4e00\u6761\u7ebf\n    for (var x = sx; x < ex; x++) {\n        this.drawPoint(new BABYLON.Vector2(x, y), color);\n    }\n}\n\npublic drawTriangle(p1: BABYLON.Vector3, p2: BABYLON.Vector3, \n                    p3: BABYLON.Vector3, color: BABYLON.Color4): void {\n    \/\/ \u8fdb\u884c\u6392\u5e8f\uff0cp1\u603b\u5728\u6700\u4e0a\u9762\uff0cp2\u603b\u5728\u6700\u4e2d\u95f4\uff0cp3\u603b\u5728\u6700\u4e0b\u9762\n    if (p1.y > p2.y) {\n        var temp = p2;\n        p2 = p1;\n        p1 = temp;\n    }\n\n    if (p2.y > p3.y) {\n        var temp = p2;\n        p2 = p3;\n        p3 = temp;\n    }\n\n    if (p1.y > p2.y) {\n        var temp = p2;\n        p2 = p1;\n        p1 = temp;\n    }\n\n    \/\/ \u53cd\u5411\u659c\u7387\n    var dP1P2: number; var dP1P3: number;\n\n    \/\/ http:\/\/en.wikipedia.org\/wiki\/Slope\n    \/\/ \u8ba1\u7b97\u53cd\u5411\u659c\u7387\n    if (p2.y - p1.y > 0)\n        dP1P2 = (p2.x - p1.x) \/ (p2.y - p1.y);\n    else\n        dP1P2 = 0;\n\n    if (p3.y - p1.y > 0)\n        dP1P3 = (p3.x - p1.x) \/ (p3.y - p1.y);\n    else\n        dP1P3 = 0;\n\n    \/\/ \u5bf9\u4e8e\u7b2c\u4e00\u79cd\u60c5\u51b5\u6765\u8bf4\uff0c\u4e09\u89d2\u5f62\u662f\u8fd9\u6837\u7684\uff1a\n    \/\/ P1\n    \/\/ -\n    \/\/ -- \n    \/\/ - -\n    \/\/ -  -\n    \/\/ -   - P2\n    \/\/ -  -\n    \/\/ - -\n    \/\/ -\n    \/\/ P3\n    if (dP1P2 > dP1P3) {\n        for (var y = p1.y >> 0; y <= p3.y >> 0; y++)\n        {\n            if (y < p2.y) {\n                this.processScanLine(y, p1, p3, p1, p2, color);\n            }\n            else {\n                this.processScanLine(y, p1, p3, p2, p3, color);\n            }\n        }\n    }\n    \/\/ \u5bf9\u4e8e\u7b2c\u4e8c\u79cd\u60c5\u51b5\u6765\u8bf4\uff0c\u4e09\u89d2\u5f62\u662f\u8fd9\u6837\u7684\uff1a\n    \/\/       P1\n    \/\/        -\n    \/\/       -- \n    \/\/      - -\n    \/\/     -  -\n    \/\/ P2 -   - \n    \/\/     -  -\n    \/\/      - -\n    \/\/        -\n    \/\/       P3\n    else {\n        for (var y = p1.y >> 0; y <= p3.y >> 0; y++)\n        {\n            if (y < p2.y) {\n                this.processScanLine(y, p1, p2, p1, p3, color);\n            }\n            else {\n                this.processScanLine(y, p2, p3, p1, p3, color);\n            }\n        }\n    }\n}\n\n~~~\n  \n\u3010\u8bd1\u8005\u6ce8\uff1aJavaScript\u4ee3\u7801\u3011\n\n~~~\n\/\/ \u9650\u5236\u6570\u503c\u8303\u56f4\u57280\u548c1\u4e4b\u95f4\nDevice.prototype.clamp = function (value, min, max) {\n    if (typeof min === \"undefined\") { min = 0; }\n    if (typeof max === \"undefined\") { max = 1; }\n    return Math.max(min, Math.min(value, max));\n};\n\n\/\/ \u8fc7\u6e21\u63d2\u503c\nDevice.prototype.interpolate = function (min, max, gradient) {\n    return min + (max - min) * this.clamp(gradient);\n};\n\n\/\/ \u5728\u4e24\u70b9\u4e4b\u95f4\u4ece\u5de6\u5230\u53f3\u7ed8\u5236\u4e00\u6761\u7ebf\u6bb5\n\/\/ papb -> pcpd\n\/\/ pa, pb, pc, pd\u5728\u4e4b\u524d\u5fc5\u987b\u5df2\u7ecf\u6392\u597d\u5e8f\nDevice.prototype.processScanLine = function (y, pa, pb, pc, pd, color) {\n    \/\/ \u7531\u5f53\u524d\u7684y\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba1\u7b97\u51fa\u68af\u5ea6\n    \/\/ \u4ee5\u6b64\u518d\u8ba1\u7b97\u51fa \u8d77\u59cbX(sx) \u548c \u7ed3\u675fX(ex)\n    \/\/ \u5982\u679cpa.Y == pb.Y \u6216\u8005 pc.Y== pd.y\u7684\u8bdd\uff0c\u68af\u5ea6\u5f3a\u5236\u4e3a1\n    var gradient1 = pa.y != pb.y ? (y - pa.y) \/ (pb.y - pa.y) : 1;\n    var gradient2 = pc.y != pd.y ? (y - pc.y) \/ (pd.y - pc.y) : 1;\n\n    var sx = this.interpolate(pa.x, pb.x, gradient1) >> 0;\n    var ex = this.interpolate(pc.x, pd.x, gradient2) >> 0;\n\n    \/\/ \u4ece\u5de6(sx)\u5411\u53f3(ex)\u7ed8\u5236\u4e00\u6761\u7ebf\n    for (var x = sx; x < ex; x++) {\n        this.drawPoint(new BABYLON.Vector2(x, y), color);\n    }\n};\n\nDevice.prototype.drawTriangle = function (p1, p2, p3, color) {\n    \/\/ \u8fdb\u884c\u6392\u5e8f\uff0cp1\u603b\u5728\u6700\u4e0a\u9762\uff0cp2\u603b\u5728\u6700\u4e2d\u95f4\uff0cp3\u603b\u5728\u6700\u4e0b\u9762\n    if (p1.y > p2.y) {\n        var temp = p2;\n        p2 = p1;\n        p1 = temp;\n    }\n    if (p2.y > p3.y) {\n        var temp = p2;\n        p2 = p3;\n        p3 = temp;\n    }\n    if (p1.y > p2.y) {\n        var temp = p2;\n        p2 = p1;\n        p1 = temp;\n    }\n\n    \/\/ \u53cd\u5411\u659c\u7387\n    var dP1P2; var dP1P3;\n\n    \/\/ http:\/\/en.wikipedia.org\/wiki\/Slope\n    \/\/ \u8ba1\u7b97\u53cd\u5411\u659c\u7387\n    if (p2.y - p1.y > 0) {\n        dP1P2 = (p2.x - p1.x) \/ (p2.y - p1.y);\n    } else {\n        dP1P2 = 0;\n    }\n\n    if (p3.y - p1.y > 0) {\n        dP1P3 = (p3.x - p1.x) \/ (p3.y - p1.y);\n    } else {\n        dP1P3 = 0;\n    }\n\n    \/\/ \u5bf9\u4e8e\u7b2c\u4e00\u79cd\u60c5\u51b5\u6765\u8bf4\uff0c\u4e09\u89d2\u5f62\u662f\u8fd9\u6837\u7684\uff1a\n    \/\/ P1\n    \/\/ -\n    \/\/ -- \n    \/\/ - -\n    \/\/ -  -\n    \/\/ -   - P2\n    \/\/ -  -\n    \/\/ - -\n    \/\/ -\n    \/\/ P3\n    if (dP1P2 > dP1P3) {\n        for (var y = p1.y >> 0; y <= p3.y >> 0; y++) {\n            if (y < p2.y) {\n                this.processScanLine(y, p1, p3, p1, p2, color);\n            } else {\n                this.processScanLine(y, p1, p3, p2, p3, color);\n            }\n        }\n    }\n        \/\/ \u5bf9\u4e8e\u7b2c\u4e8c\u79cd\u60c5\u51b5\u6765\u8bf4\uff0c\u4e09\u89d2\u5f62\u662f\u8fd9\u6837\u7684\uff1a\n        \/\/       P1\n        \/\/        -\n        \/\/       -- \n        \/\/      - -\n        \/\/     -  -\n        \/\/ P2 -   - \n        \/\/     -  -\n        \/\/      - -\n        \/\/        -\n        \/\/       P3\n    else {\n        for (var y = p1.y >> 0; y <= p3.y >> 0; y++) {\n            if (y < p2.y) {\n                this.processScanLine(y, p1, p2, p1, p3, color);\n            } else {\n                this.processScanLine(y, p2, p3, p1, p3, color);\n            }\n        }\n    }\n};\n\n~~~\n  \n\u4f60\u5df2\u7ecf\u4e86\u89e3\u4e86\u5982\u4f55\u5904\u7406\u4e24\u79cd\u4e09\u89d2\u5f62\u7684\u586b\u5199\u4ee5\u53ca\u626b\u63cf\u7ebf\u4e2d\u6240\u505a\u7684\u64cd\u4f5c\u4e86\u3002\n\n  \n\n\u6700\u540e\uff0c\u4f60\u9700\u8981\u66f4\u65b0\u6e32\u67d3\u51fd\u6570\uff0c\u7528drawTriangle\u6765\u66ff\u4ee3drawLine\u548cdrawBline\u3002\u6211\u4eec\u8fd8\u7528\u4e86\u4e0d\u540c\u7684\u7070\u8272\u586b\u5145\u6bcf\u4e2a\u4e09\u89d2\u5f62\u3002\u4e0d\u7136\u7684\u8bdd\uff0c\u6574\u4e2a\u753b\u9762\u4e00\u7247\u7070\u4f60\u6839\u672c\u5c31\u770b\u4e0d\u51fa\u6548\u679c\u6765\u3002\u6211\u4eec\u5c06\u5728\u63a5\u4e0b\u6765\u7684\u6559\u7a0b\u4e2d\u5b66\u4e60\u5230\u5982\u4f55\u6070\u5f53\u7684\u5904\u7406\u5149\u7167\u3002\n\n\u3010\u8bd1\u8005\u6ce8\uff1aC#\u4ee3\u7801\u3011\n\n~~~\nvar faceIndex = 0;\nforeach (var face in mesh.Faces)\n{\n    var vertexA = mesh.Vertices[face.A];\n    var vertexB = mesh.Vertices[face.B];\n    var vertexC = mesh.Vertices[face.C];\n\n    var pixelA = Project(vertexA, transformMatrix);\n    var pixelB = Project(vertexB, transformMatrix);\n    var pixelC = Project(vertexC, transformMatrix);\n\n    var color = 0.25f + (faceIndex % mesh.Faces.Length) * 0.75f \/ mesh.Faces.Length;\n    DrawTriangle(pixelA, pixelB, pixelC, new Color4(color, color, color, 1));\n    faceIndex++;\n}\n~~~\n  \n\u3010\u8bd1\u8005\u6ce8\uff1aTypeScript\u4ee3\u7801\u3011\n\n~~~\nfor (var indexFaces = 0; indexFaces < cMesh.Faces.length; indexFaces++) {\n    var currentFace = cMesh.Faces[indexFaces];\n    var vertexA = cMesh.Vertices[currentFace.A];\n    var vertexB = cMesh.Vertices[currentFace.B];\n    var vertexC = cMesh.Vertices[currentFace.C];\n\n    var pixelA = this.project(vertexA, transformMatrix);\n    var pixelB = this.project(vertexB, transformMatrix);\n    var pixelC = this.project(vertexC, transformMatrix);\n\n    var color: number = 0.25 + ((indexFaces % cMesh.Faces.length) \/ cMesh.Faces.length) * 0.75;\n    this.drawTriangle(pixelA, pixelB, pixelC, new BABYLON.Color4(color, color, color, 1));\n}\n~~~\n  \n\u3010\u8bd1\u8005\u6ce8\uff1aJavaScript\u4ee3\u7801\u3011\n\n~~~\nfor (var indexFaces = 0; indexFaces < cMesh.Faces.length; indexFaces++) {\n    var currentFace = cMesh.Faces[indexFaces];\n    var vertexA = cMesh.Vertices[currentFace.A];\n    var vertexB = cMesh.Vertices[currentFace.B];\n    var vertexC = cMesh.Vertices[currentFace.C];\n\n    var pixelA = this.project(vertexA, transformMatrix);\n    var pixelB = this.project(vertexB, transformMatrix);\n    var pixelC = this.project(vertexC, transformMatrix);\n\n    var color = 0.25 + ((indexFaces % cMesh.Faces.length) \/ cMesh.Faces.length) * 0.75;\n    this.drawTriangle(pixelA, pixelB, pixelC, new BABYLON.Color4(color, color, color, 1));\n}\n~~~\n  \n\u7ed3\u679c\u5e94\u8be5\u662f\u8fd9\u6837\u7684\uff1a\n\n[\u8fd0\u884c\u4ee3\u7801](http:\/\/david.blob.core.windows.net\/softengine3d\/part4sample1\/index.html)\n\n  \n\n\u8fd9\u662f\u600e\u4e48\u56de\u4e8b\uff1f\u4e3a\u4ec0\u4e48\u611f\u89c9\u8fd9\u4e48\u5947\u602a\uff1f\uff01\u55ef~\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u6ca1\u6709\u6b63\u786e\u7684\u628a\u6b63\u9762\u7684\u4e09\u89d2\u5f62\u753b\u5728\u6b63\u9762\u3002\u3010\u8bd1\u8005\u6ce8\uff1a\u6211\u662f\u8fd9\u4e48\u7ffb\u8bd1\u7684\uff0c\u4f60\u5c31\u8fd9\u4e48\u4e00\u770b~\u3011\n\n  \n\n\u5982\u4f55\u4f7f\u7528\u6df1\u5ea6\u7f13\u51b2\n\n\u6211\u4eec\u9700\u8981\u5bf9\u5f53\u524d\u7684Z\u503c\u5728\u7f13\u51b2\u533a\u4e2d\u8fdb\u884c\u6bd4\u8f83\u3002\n\n  \n\n\u5982\u679c\u5f53\u524d\u8981\u7ed8\u5236\u7684\u50cf\u7d20Z\u503c\u662f\u6700\u524d\u9762\u7684\uff08\u6700\u9760\u8fd1\u5c4f\u5e55\uff09\uff0c\u5219\u53ef\u4ee5\u7ed8\u5236\u3002\n\n\u7136\u800c\uff0c\u5982\u679c\u5f53\u524dZ\u503c\u5927\u4e8e\u524d\u9762\u7684\u50cf\u7d20\uff0c\u5219\u53ef\u4ee5\u88ab\u4e22\u5f03\u3002\n\n  \n\n\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u4e1c\u897f\u7528\u6765\u4fdd\u5b58\u6df1\u5ea6\u7f13\u51b2\u533a\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u58f0\u660e\u4e00\u4e2a\u65b0\u7684\u6570\u7ec4\uff0c\u5e76\u5c06\u5176\u547d\u540d\u4e3a\u6df1\u5ea6\u7f13\u51b2\u533a(depthBuffer)\u3002\u8be5\u6570\u7ec4\u7684\u5927\u5c0f\u7b49\u4e8e \u5c4f\u5e55(width * height)\u3002\n\n\u6bcf\u6b21\u8c03\u7528 clear() \u51fd\u6570\u65f6\u6df1\u5ea6\u7f13\u51b2\u533a\u5185\u7684\u6bcf\u4e00\u4e2a\u5143\u7d20\u90fd\u9700\u8981\u4e00\u4e2a\u975e\u5e38\u9ad8\u7684\u9ed8\u8ba4Z\u503c\u3002\n\n  \n\n\u5728putPixel(\u51fd\u6570\/\u65b9\u6cd5)\u4e2d\uff0c\u6211\u4eec\u9700\u8981\u6d4b\u8bd5\u5df2\u5b58\u50a8\u5728\u7f13\u51b2\u533a\u4e2d\u67d0\u4e2a\u6307\u5b9a\u7684\u50cf\u7d20Z\u503c\u3002\u6b64\u5916\uff0c\u6211\u4eec\u4ee5\u524d\u7684\u903b\u8f91\u63a5\u6536Vector2\u7528\u4e8e\u7ed8\u5236\u5728\u5c4f\u5e55\u4e0a\u3002\u73b0\u5728\u6211\u4eec\u5c06\u5176\u6539\u4e3aVector3\u7528\u4e8e\u589e\u52a0Z\u503c\u3002\u56e0\u4e3a\u73b0\u5728\u6211\u4eec\u5c06\u9700\u8981\u8fd9\u90e8\u5206\u65b0\u4fe1\u606f\u7528\u4e8e\u6b63\u786e\u7ed8\u5236\u9762\u7247\u3002\n\n  \n\n\u6700\u540e\uff0c\u5728\u6211\u4eec\u7684\u4e09\u89d2\u5f62\u5185\uff0c\u540c\u6837\u9700\u8981\u4e00\u4e2a\u7c7b\u4f3c x \u503c\u63d2\u503c\u7684\u65b9\u5f0f\u5bf9 z \u503c\u8fdb\u884c\u63d2\u503c\u3002\n\n  \n\n\u603b\u4e4b\uff0c\u8fd9\u91cc\u662f\u4f60\u6240\u9700\u8981\u5bf9\u8bbe\u5907\u5bf9\u8c61\u66f4\u65b0\u7684\u4ee3\u7801\uff1a\n\n\u3010\u8bd1\u8005\u6ce8\uff1aC#\u4ee3\u7801\u3011\n\n~~~\nprivate byte[] backBuffer;\nprivate readonly float[] depthBuffer;\nprivate WriteableBitmap bmp;\nprivate readonly int renderWidth;\nprivate readonly int renderHeight;\n\npublic Device(WriteableBitmap bmp)\n{\n    this.bmp = bmp;\n    renderWidth = bmp.PixelWidth;\n    renderHeight = bmp.PixelHeight;\n\n    \/\/ \u540e\u53f0\u7f13\u51b2\u533a\u5927\u5c0f\u503c\u662f\u8981\u7ed8\u5236\u7684\u50cf\u7d20  \n    \/\/ \u5c4f\u5e55(width*height) * 4 (R,G,B & Alpha\u503c) \n    backBuffer = new byte[bmp.PixelWidth * bmp.PixelHeight * 4];\n    depthBuffer = new float[bmp.PixelWidth * bmp.PixelHeight];\n}\n\n\/\/ \u6e05\u9664\u540e\u53f0\u7f13\u51b2\u533a\u4e3a\u6307\u5b9a\u989c\u8272 \npublic void Clear(byte r, byte g, byte b, byte a)\n{\n    \/\/ \u6e05\u9664\u540e\u53f0\u7f13\u51b2\u533a\n    for (var index = 0; index < backBuffer.Length; index += 4)\n    {\n        \/\/ Windows\u4f7f\u7528BGRA\uff0c\u800c\u4e0d\u662fHtml5\u4e2d\u4f7f\u7528\u7684RGBA \n        backBuffer[index] = b;\n        backBuffer[index + 1] = g;\n        backBuffer[index + 2] = r;\n        backBuffer[index + 3] = a;\n    }\n\n    \/\/ \u6e05\u9664\u6df1\u5ea6\u7f13\u51b2\u533a\n    for (var index = 0; index < depthBuffer.Length; index++)\n    {\n        depthBuffer[index] = float.MaxValue;\n    }\n}\n\n\/\/ \u8c03\u7528\u6b64\u65b9\u6cd5\u628a\u4e00\u4e2a\u50cf\u7d20\u7ed8\u5236\u5230\u6307\u5b9a\u7684X, Y\u5750\u6807\u4e0a  \npublic void PutPixel(int x, int y, float z, Color4 color)\n{\n    \/\/ \u6211\u4eec\u7684\u540e\u53f0\u7f13\u51b2\u533a\u662f\u4e00\u7ef4\u6570\u7ec4  \n    \/\/ \u8fd9\u91cc\u6211\u4eec\u7b80\u5355\u8ba1\u7b97\uff0c\u5c06X\u548cY\u5bf9\u5e94\u5230\u6b64\u4e00\u7ef4\u6570\u7ec4\u4e2d  \n    var index = (x + y * renderWidth);\n    var index4 = index * 4;\n\n    if (depthBuffer[index] < z)\n    {\n        return; \/\/ \u6df1\u5ea6\u6d4b\u8bd5\u4e0d\u901a\u8fc7\n    }\n\n    depthBuffer[index] = z;\n\n    backBuffer[index4] = (byte)(color.Blue * 255);\n    backBuffer[index4 + 1] = (byte)(color.Green * 255);\n    backBuffer[index4 + 2] = (byte)(color.Red * 255);\n    backBuffer[index4 + 3] = (byte)(color.Alpha * 255);\n}\n\n\/\/ \u5c06\u4e09\u7ef4\u5750\u6807\u548c\u53d8\u6362\u77e9\u9635\u8f6c\u6362\u6210\u4e8c\u7ef4\u5750\u6807  \npublic Vector3 Project(Vector3 coord, Matrix transMat)\n{\n    \/\/ \u8fdb\u884c\u5750\u6807\u53d8\u6362  \n    var point = Vector3.TransformCoordinate(coord, transMat);\n    \/\/ \u53d8\u6362\u540e\u7684\u5750\u6807\u8d77\u59cb\u70b9\u662f\u5750\u6807\u7cfb\u7684\u4e2d\u5fc3\u70b9  \n    \/\/ \u4f46\u662f\uff0c\u5728\u5c4f\u5e55\u4e0a\uff0c\u6211\u4eec\u4ee5\u5de6\u4e0a\u89d2\u4e3a\u8d77\u59cb\u70b9  \n    \/\/ \u6211\u4eec\u9700\u8981\u91cd\u65b0\u8ba1\u7b97\u4f7f\u4ed6\u4eec\u7684\u8d77\u59cb\u70b9\u53d8\u6210\u5de6\u4e0a\u89d2 \n    var x = point.X * bmp.PixelWidth + bmp.PixelWidth \/ 2.0f;\n    var y = -point.Y * bmp.PixelHeight + bmp.PixelHeight \/ 2.0f;\n    return (new Vector3(x, y, point.Z));\n}\n\n\/\/ \u5982\u679c\u4e8c\u7ef4\u5750\u6807\u5728\u53ef\u89c6\u8303\u56f4\u5185\u5219\u7ed8\u5236 \npublic void DrawPoint(Vector3 point, Color4 color)\n{\n    \/\/ \u5224\u65ad\u662f\u5426\u5728\u5c4f\u5e55\u5185 \n    if (point.X >= 0 && point.Y >= 0 && point.X < bmp.PixelWidth && point.Y < bmp.PixelHeight)\n    {\n        \/\/ \u7ed8\u5236\u4e00\u4e2a\u70b9\n        PutPixel((int)point.X, (int)point.Y, point.Z, color);\n    }\n}\n\n\/\/ \u5728\u4e24\u70b9\u4e4b\u95f4\u4ece\u5de6\u5230\u53f3\u7ed8\u5236\u4e00\u6761\u7ebf\u6bb5\n\/\/ papb -> pcpd\n\/\/ pa, pb, pc, pd\u5728\u4e4b\u524d\u5fc5\u987b\u5df2\u7ecf\u6392\u597d\u5e8f\nvoid ProcessScanLine(int y, Vector3 pa, Vector3 pb, Vector3 pc, Vector3 pd, Color4 color)\n{\n    \/\/ \u7531\u5f53\u524d\u7684y\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba1\u7b97\u51fa\u68af\u5ea6\n    \/\/ \u4ee5\u6b64\u518d\u8ba1\u7b97\u51fa \u8d77\u59cbX(sx) \u548c \u7ed3\u675fX(ex)\n    \/\/ \u5982\u679cpa.Y == pb.Y \u6216\u8005 pc.Y== pd.y\u7684\u8bdd\uff0c\u68af\u5ea6\u5f3a\u5236\u4e3a1\n    var gradient1 = pa.Y != pb.Y ? (y - pa.Y) \/ (pb.Y - pa.Y) : 1;\n    var gradient2 = pc.Y != pd.Y ? (y - pc.Y) \/ (pd.Y - pc.Y) : 1;\n\n    int sx = (int)Interpolate(pa.X, pb.X, gradient1);\n    int ex = (int)Interpolate(pc.X, pd.X, gradient2);\n\n    \/\/ \u8ba1\u7b97 \u5f00\u59cbZ\u503c \u548c \u7ed3\u675fZ\u503c\n    float z1 = Interpolate(pa.Z, pb.Z, gradient1);\n    float z2 = Interpolate(pc.Z, pd.Z, gradient2);\n\n    \/\/ \u4ece\u5de6(sx)\u5411\u53f3(ex)\u7ed8\u5236\u4e00\u6761\u7ebf\n    for (var x = sx; x < ex; x++)\n    {\n        float gradient = (x - sx) \/ (float)(ex - sx);\n\n        var z = Interpolate(z1, z2, gradient);\n        DrawPoint(new Vector3(x, y, z), color);\n    }\n}\n~~~\n  \n\u3010\u8bd1\u8005\u6ce8\uff1aTypeScript\u4ee3\u7801\u3011\n\n~~~\n\/\/ \u540e\u53f0\u7f13\u51b2\u533a\u5927\u5c0f\u503c\u662f\u8981\u7ed8\u5236\u7684\u50cf\u7d20  \n\/\/ \u5c4f\u5e55(width*height) * 4 (R,G,B & Alpha\u503c) \nprivate backbuffer: ImageData;\nprivate workingCanvas: HTMLCanvasElement;\nprivate workingContext: CanvasRenderingContext2D;\nprivate workingWidth: number;\nprivate workingHeight: number;\n\/\/ \u7b49\u540c\u4e8ebackbuffer.data\nprivate backbufferdata;\nprivate depthbuffer: number[];\n\nconstructor(canvas: HTMLCanvasElement) {\n    this.workingCanvas = canvas;\n    this.workingWidth = canvas.width;\n    this.workingHeight = canvas.height;\n    this.workingContext = this.workingCanvas.getContext(\"2d\");\n    this.depthbuffer = new Array(this.workingWidth * this.workingHeight);\n}\n\n\/\/ \u7528\u6307\u5b9a\u989c\u8272\u6e05\u9664\u540e\u53f0\u7f13\u51b2\u533a\npublic clear(): void {\n    \/\/ \u4f7f\u7528\u9ed8\u8ba4\u989c\u8272\u6e05\u9664\u540e\u53f0\u7f13\u51b2\u533a\n    this.workingContext.clearRect(0, 0, this.workingWidth, this.workingHeight);\n    \/\/ \u7f13\u5b58\u540e\u53f0\u7f13\u51b2\u533a\n    this.backbuffer = this.workingContext.getImageData(0, 0, this.workingWidth, this.workingHeight);\n\n    \/\/ \u6e05\u9664\u6df1\u5ea6\u7f13\u51b2\u533a\n    for (var i = 0; i < this.depthbuffer.length; i++) {\n        \/\/ \u4f7f\u7528\u6700\u5927\u503c\u586b\u5145\n        this.depthbuffer[i] = 10000000;\n    }\n}\n\n\/\/ \u8c03\u7528\u6b64\u65b9\u6cd5\u628a\u4e00\u4e2a\u50cf\u7d20\u7ed8\u5236\u5230\u6307\u5b9a\u7684X, Y\u5750\u6807\u4e0a \npublic putPixel(x: number, y: number, z: number, color: BABYLON.Color4): void {\n    this.backbufferdata = this.backbuffer.data;\n    \/\/ \u6211\u4eec\u7684\u540e\u53f0\u7f13\u51b2\u533a\u662f\u4e00\u7ef4\u6570\u7ec4  \n    \/\/ \u8fd9\u91cc\u6211\u4eec\u7b80\u5355\u8ba1\u7b97\uff0c\u5c06X\u548cY\u5bf9\u5e94\u5230\u6b64\u4e00\u7ef4\u6570\u7ec4\u4e2d  \n    var index: number = ((x >> 0) + (y >> 0) * this.workingWidth);\n    var index4: number = index * 4;\n\n    if (this.depthbuffer[index] < z) {\n        return; \/\/ \u6df1\u5ea6\u6d4b\u8bd5\u4e0d\u901a\u8fc7\n    }\n\n    this.depthbuffer[index] = z;\n\n    \/\/ \u5728Html5 canvas\u4e2d\u4f7f\u7528RGBA\u989c\u8272\u7a7a\u95f4  \n    this.backbufferdata[index4] = color.r * 255;\n    this.backbufferdata[index4 + 1] = color.g * 255;\n    this.backbufferdata[index4 + 2] = color.b * 255;\n    this.backbufferdata[index4 + 3] = color.a * 255;\n}\n\n\/\/ \u5c06\u4e09\u7ef4\u5750\u6807\u548c\u53d8\u6362\u77e9\u9635\u8f6c\u6362\u6210\u4e8c\u7ef4\u5750\u6807 \npublic project(coord: BABYLON.Vector3, transMat: BABYLON.Matrix): BABYLON.Vector3 {\n    \/\/ \u8fdb\u884c\u5750\u6807\u53d8\u6362  \n    var point = BABYLON.Vector3.TransformCoordinates(coord, transMat);\n    \/\/ \u53d8\u6362\u540e\u7684\u5750\u6807\u8d77\u59cb\u70b9\u662f\u5750\u6807\u7cfb\u7684\u4e2d\u5fc3\u70b9  \n    \/\/ \u4f46\u662f\uff0c\u5728\u5c4f\u5e55\u4e0a\uff0c\u6211\u4eec\u4ee5\u5de6\u4e0a\u89d2\u4e3a\u8d77\u59cb\u70b9  \n    \/\/ \u6211\u4eec\u9700\u8981\u91cd\u65b0\u8ba1\u7b97\u4f7f\u4ed6\u4eec\u7684\u8d77\u59cb\u70b9\u53d8\u6210\u5de6\u4e0a\u89d2  \n    var x = point.x * this.workingWidth + this.workingWidth \/ 2.0;\n    var y = -point.y * this.workingHeight + this.workingHeight \/ 2.0;\n    return (new BABYLON.Vector3(x, y, point.z));\n}\n\n\/\/ \u5982\u679c\u4e8c\u7ef4\u5750\u6807\u5728\u53ef\u89c6\u8303\u56f4\u5185\u5219\u7ed8\u5236  \npublic drawPoint(point: BABYLON.Vector3, color: BABYLON.Color4): void {\n    \/\/ \u5224\u65ad\u662f\u5426\u5728\u5c4f\u5e55\u5185  \n    if (point.x >= 0 && point.y >= 0 && point.x < this.workingWidth && point.y < this.workingHeight) {\n        \/\/ \u7ed8\u5236\u4e00\u4e2a\u70b9\n        this.putPixel(point.x, point.y, point.z, color);\n    }\n}\n\n\/\/ \u5728\u4e24\u70b9\u4e4b\u95f4\u4ece\u5de6\u5230\u53f3\u7ed8\u5236\u4e00\u6761\u7ebf\u6bb5\n\/\/ papb -> pcpd\n\/\/ pa, pb, pc, pd\u5728\u4e4b\u524d\u5fc5\u987b\u5df2\u7ecf\u6392\u597d\u5e8f\npublic processScanLine(y: number, pa: BABYLON.Vector3, pb: BABYLON.Vector3, pc: BABYLON.Vector3, pd: BABYLON.Vector3, color: BABYLON.Color4): void {\n    \/\/ \u7531\u5f53\u524d\u7684y\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba1\u7b97\u51fa\u68af\u5ea6\n    \/\/ \u4ee5\u6b64\u518d\u8ba1\u7b97\u51fa \u8d77\u59cbX(sx) \u548c \u7ed3\u675fX(ex)\n    \/\/ \u5982\u679cpa.Y == pb.Y \u6216\u8005 pc.Y== pd.y\u7684\u8bdd\uff0c\u68af\u5ea6\u5f3a\u5236\u4e3a1\n    var gradient1 = pa.y != pb.y ? (y - pa.y) \/ (pb.y - pa.y) : 1;\n    var gradient2 = pc.y != pd.y ? (y - pc.y) \/ (pd.y - pc.y) : 1;\n\n    var sx = this.interpolate(pa.x, pb.x, gradient1) >> 0;\n    var ex = this.interpolate(pc.x, pd.x, gradient2) >> 0;\n\n    \/\/ \u8ba1\u7b97 \u5f00\u59cbZ\u503c \u548c \u7ed3\u675fZ\u503c\n    var z1: number = this.interpolate(pa.z, pb.z, gradient1);\n    var z2: number = this.interpolate(pc.z, pd.z, gradient2);\n\n    \/\/ \u4ece\u5de6(sx)\u5411\u53f3(ex)\u7ed8\u5236\u4e00\u6761\u7ebf\n    for (var x = sx; x < ex; x++) {\n        var gradient: number = (x - sx) \/ (ex - sx); \/\/ \u89c4\u8303\u4ece\u5de6\u5f80\u53f3\u7ed8\u5236\n\n        var z = this.interpolate(z1, z2, gradient);\n\n        this.drawPoint(new BABYLON.Vector3(x, y, z), color);\n    }\n}\n~~~\n  \n\u3010\u8bd1\u8005\u6ce8\uff1aJavaScript\u4ee3\u7801\u3011\n\n~~~\nfunction Device(canvas) {\n    this.workingCanvas = canvas;\n    this.workingWidth = canvas.width;\n    this.workingHeight = canvas.height;\n    this.workingContext = this.workingCanvas.getContext(\"2d\");\n    this.depthbuffer = new Array(this.workingWidth * this.workingHeight);\n}\n\n\/\/ \u7528\u6307\u5b9a\u989c\u8272\u6e05\u9664\u540e\u53f0\u7f13\u51b2\u533a\nDevice.prototype.clear = function () {\n    \/\/ \u4f7f\u7528\u9ed8\u8ba4\u989c\u8272\u6e05\u9664\u540e\u53f0\u7f13\u51b2\u533a\n    this.workingContext.clearRect(0, 0, this.workingWidth, this.workingHeight);\n    \/\/ \u7f13\u5b58\u540e\u53f0\u7f13\u51b2\u533a\n    this.backbuffer = this.workingContext.getImageData(0, 0, this.workingWidth, this.workingHeight);\n\n    \/\/ \u6e05\u9664\u6df1\u5ea6\u7f13\u51b2\u533a\n    for (var i = 0; i < this.depthbuffer.length; i++) {\n        \/\/ \u4f7f\u7528\u6700\u5927\u503c\u586b\u5145\n        this.depthbuffer[i] = 10000000;\n    }\n};\n\n\/\/ \u8c03\u7528\u6b64\u65b9\u6cd5\u628a\u4e00\u4e2a\u50cf\u7d20\u7ed8\u5236\u5230\u6307\u5b9a\u7684X, Y\u5750\u6807\u4e0a \nDevice.prototype.putPixel = function (x, y, z, color) {\n    this.backbufferdata = this.backbuffer.data;\n    \/\/ \u6211\u4eec\u7684\u540e\u53f0\u7f13\u51b2\u533a\u662f\u4e00\u7ef4\u6570\u7ec4  \n    \/\/ \u8fd9\u91cc\u6211\u4eec\u7b80\u5355\u8ba1\u7b97\uff0c\u5c06X\u548cY\u5bf9\u5e94\u5230\u6b64\u4e00\u7ef4\u6570\u7ec4\u4e2d  \n    var index = ((x >> 0) + (y >> 0) * this.workingWidth);\n    var index4 = index * 4;\n\n    if (this.depthbuffer[index] < z) {\n        return; \/\/ \u6df1\u5ea6\u6d4b\u8bd5\u4e0d\u901a\u8fc7\n    }\n\n    this.depthbuffer[index] = z;\n\n    \/\/ \u5728Html5 canvas\u4e2d\u4f7f\u7528RGBA\u989c\u8272\u7a7a\u95f4  \n    this.backbufferdata[index4] = color.r * 255;\n    this.backbufferdata[index4 + 1] = color.g * 255;\n    this.backbufferdata[index4 + 2] = color.b * 255;\n    this.backbufferdata[index4 + 3] = color.a * 255;\n};\n\n\/\/ \u5c06\u4e09\u7ef4\u5750\u6807\u548c\u53d8\u6362\u77e9\u9635\u8f6c\u6362\u6210\u4e8c\u7ef4\u5750\u6807 \nDevice.prototype.project = function (coord, transMat) {\n    \/\/ \u8fdb\u884c\u5750\u6807\u53d8\u6362  \n    var point = BABYLON.Vector3.TransformCoordinates(coord, transMat);\n    \/\/ \u53d8\u6362\u540e\u7684\u5750\u6807\u8d77\u59cb\u70b9\u662f\u5750\u6807\u7cfb\u7684\u4e2d\u5fc3\u70b9  \n    \/\/ \u4f46\u662f\uff0c\u5728\u5c4f\u5e55\u4e0a\uff0c\u6211\u4eec\u4ee5\u5de6\u4e0a\u89d2\u4e3a\u8d77\u59cb\u70b9  \n    \/\/ \u6211\u4eec\u9700\u8981\u91cd\u65b0\u8ba1\u7b97\u4f7f\u4ed6\u4eec\u7684\u8d77\u59cb\u70b9\u53d8\u6210\u5de6\u4e0a\u89d2\n    var x = point.x * this.workingWidth + this.workingWidth \/ 2.0;\n    var y = -point.y * this.workingHeight + this.workingHeight \/ 2.0;\n    return (new BABYLON.Vector3(x, y, point.z));\n};\n\n\/\/ \u5982\u679c\u4e8c\u7ef4\u5750\u6807\u5728\u53ef\u89c6\u8303\u56f4\u5185\u5219\u7ed8\u5236  \nDevice.prototype.drawPoint = function (point, color) {\n    \/\/ \u5224\u65ad\u662f\u5426\u5728\u5c4f\u5e55\u5185  \n    if (point.x >= 0 && point.y >= 0 && point.x < this.workingWidth && point.y < this.workingHeight) {\n        \/\/ \u7ed8\u5236\u4e00\u4e2a\u70b9\n        this.putPixel(point.x, point.y, point.z, color);\n    }\n};\n\n\/\/ \u5728\u4e24\u70b9\u4e4b\u95f4\u4ece\u5de6\u5230\u53f3\u7ed8\u5236\u4e00\u6761\u7ebf\u6bb5\n\/\/ papb -> pcpd\n\/\/ pa, pb, pc, pd\u5728\u4e4b\u524d\u5fc5\u987b\u5df2\u7ecf\u6392\u597d\u5e8f\nDevice.prototype.processScanLine = function (y, pa, pb, pc, pd, color) {\n    \/\/ \u7531\u5f53\u524d\u7684y\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba1\u7b97\u51fa\u68af\u5ea6\n    \/\/ \u4ee5\u6b64\u518d\u8ba1\u7b97\u51fa \u8d77\u59cbX(sx) \u548c \u7ed3\u675fX(ex)\n    \/\/ \u5982\u679cpa.Y == pb.Y \u6216\u8005 pc.Y== pd.y\u7684\u8bdd\uff0c\u68af\u5ea6\u5f3a\u5236\u4e3a1\n    var gradient1 = pa.y != pb.y ? (y - pa.y) \/ (pb.y - pa.y) : 1;\n    var gradient2 = pc.y != pd.y ? (y - pc.y) \/ (pd.y - pc.y) : 1;\n\n    var sx = this.interpolate(pa.x, pb.x, gradient1) >> 0;\n    var ex = this.interpolate(pc.x, pd.x, gradient2) >> 0;\n\n    \/\/ \u8ba1\u7b97 \u5f00\u59cbZ\u503c \u548c \u7ed3\u675fZ\u503c\n    var z1 = this.interpolate(pa.z, pb.z, gradient1);\n    var z2 = this.interpolate(pc.z, pd.z, gradient2);\n\n    \/\/ \u4ece\u5de6(sx)\u5411\u53f3(ex)\u7ed8\u5236\u4e00\u6761\u7ebf\n    for (var x = sx; x < ex; x++) {\n        var gradient = (x - sx) \/ (ex - sx);\n        var z = this.interpolate(z1, z2, gradient);\n        this.drawPoint(new BABYLON.Vector3(x, y, z), color);\n    }\n};\n~~~\n  \n\u4f7f\u7528\u8fd9\u4e9b\u65b0\u4ee3\u7801\uff0c\u4f60\u5c06\u83b7\u5f97\u7684\u6548\u679c\uff1a\n\n[\u8fd0\u884c\u4ee3\u7801](http:\/\/david.blob.core.windows.net\/softengine3d\/part4\/index.html)\n\n  \n\n\u540c\u6837\u7684\uff0c\u4f60\u53ef\u4ee5\u4e0b\u8f7d\u6e90\u4ee3\u7801\uff1a\n\nC#\uff1a[SoftEngineCSharpPart4.zip](http:\/\/david.blob.core.windows.net\/softengine3d\/SoftEngineCSharpPart4.zip)\n\nTypeScript\uff1a[SoftEngineTSPart4.zip](http:\/\/david.blob.core.windows.net\/softengine3d\/SoftEngineTSPart4.zip)\n\nJavaScript\uff1a[SoftEngineJSPart4.zip](http:\/\/david.blob.core.windows.net\/softengine3d\/SoftEngineJSPart4.zip)\u00a0\u6216\u53ea\u9700\u53f3\u952e\u70b9\u51fb -> \u67e5\u770b\u6846\u67b6\u7684\u6e90\u4ee3\u7801\n\n  \n\n\u5728\u4e0b\u4e00\u7ae0\u8282\uff0c\u7b2c\u4e94\u4e2a\u6559\u7a0b\u4e2d\uff0c\u6211\u4eec\u5c06\u770b\u5230\u5982\u4f55\u6a21\u62df\u5149\u7167\u7740\u8272\u6548\u679c\uff0c\u6211\u4eec\u5c06\u5f97\u5230\u8fd9\u6837\u7684\u753b\u9762\uff1a\n\n![\u9ad8\u6c0f\u7740\u8272](https:\/\/box.kancloud.cn\/2016-03-22_56f0e989db68b.jpg \"\u9ad8\u6c0f\u7740\u8272\")"},
        "summary":[{"id":130052,"pid":0,"name":"default.md","title":"\u524d\u8a00","is_probation":0,"ref":"default.md","path":"130052","index":0},{"id":130053,"pid":0,"name":"49989681.md","title":"\u4e00\uff0c\u7f16\u5199\u76f8\u673a\u3001\u7f51\u683c\u548c\u8bbe\u5907\u5bf9\u8c61\u7684\u6838\u5fc3\u903b\u8f91","is_probation":0,"ref":"49989681.md","path":"130053","index":1},{"id":130054,"pid":0,"name":"49998675.md","title":"\u4e8c\uff0c\u7ed8\u5236\u7ebf\u6bb5\u548c\u4e09\u89d2\u5f62\u6765\u83b7\u5f97\u7ebf\u6846\u6e32\u67d3\u6548\u679c","is_probation":0,"ref":"49998675.md","path":"130054","index":2},{"id":130055,"pid":0,"name":"50001659.md","title":"\u4e09\uff0c\u52a0\u8f7d\u901a\u8fc7Blender\u6269\u5c55\u5bfc\u51faJSON\u683c\u5f0f\u7684\u7f51\u683c","is_probation":0,"ref":"50001659.md","path":"130055","index":3},{"id":130056,"pid":0,"name":"50010073.md","title":"\u56db\uff0c\u586b\u5145\u5149\u6805\u5316\u7684\u4e09\u89d2\u5f62\u5e76\u4f7f\u7528\u6df1\u5ea6\u7f13\u51b2","is_probation":0,"ref":"50010073.md","path":"130056","index":4},{"id":130057,"pid":0,"name":"50054509.md","title":"\u4e94\uff0c\u989d\u5916\u7ae0\u8282\uff0c\u4f7f\u7528\u6280\u5de7\u548c\u5e76\u884c\u5904\u7406\u6765\u63d0\u9ad8\u6027\u80fd","is_probation":0,"ref":"50054509.md","path":"130057","index":5},{"id":130058,"pid":0,"name":"[\u8f6f\u4ef6\u6e32\u67d3\u5668\u5165\u95e8]\u4e94-\u5e73\u9762\u7740\u8272\u548c\u9ad8\u6c0f\u7740\u8272.md","title":"\u516d\uff0c\u5e73\u9762\u7740\u8272\u548c\u9ad8\u6c0f\u7740\u8272","is_probation":0,"ref":"[\u8f6f\u4ef6\u6e32\u67d3\u5668\u5165\u95e8]\u4e94-\u5e73\u9762\u7740\u8272\u548c\u9ad8\u6c0f\u7740\u8272.md","path":"130058","index":6},{"id":130059,"pid":0,"name":"[\u8f6f\u4ef6\u6e32\u67d3\u5668\u5165\u95e8]\u516d-\u5e94\u7528\u7eb9\u7406\u3001\u80cc\u9762\u5254\u9664\u4ee5\u53ca\u4e00\u4e9bWebGL\u76f8\u5173.md","title":"\u4e03\uff0c\u5e94\u7528\u7eb9\u7406\u3001\u80cc\u9762\u5254\u9664\u4ee5\u53ca\u4e00\u4e9bWebGL\u76f8\u5173","is_probation":0,"ref":"[\u8f6f\u4ef6\u6e32\u67d3\u5668\u5165\u95e8]\u516d-\u5e94\u7528\u7eb9\u7406\u3001\u80cc\u9762\u5254\u9664\u4ee5\u53ca\u4e00\u4e9bWebGL\u76f8\u5173.md","path":"130059","index":7}]
    }
</script>
<script type="text/javascript" src="./光栅化三角形_files/reader.js.下载"></script>
<script type="text/javascript">
    kancloud.bootstrap();
</script>
    <!-- Google Analytics -->
    <script>
        window.ga = window.ga || function () {
            (ga.q = ga.q || []).push(arguments)
        };
        ga.l      = +new Date;
        ga('create', 'UA-85687835-1', 'auto', 'web');
        ga('set', 'transport', 'beacon');
        
                ga('web.send', 'pageview', {
            dimension1:8533
        });
        window.sendPageView = function (page, title) {
            ga('web.set', 'page', page);
            ga('web.set', 'title', title);
            ga('web.send', 'pageview', {
                dimension1: 8533
            });
        }
            </script>
    <script async="" src="./光栅化三角形_files/analytics.js.下载"></script>
    <!-- End Google Analytics -->

</body></html>